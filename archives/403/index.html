<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="max-image-preview:large">
<title>在 x86 上构建 Linux L3 交换机/路由器 - 郭智满的部落！</title>
<meta name="description" content="第 1 部分 - 介绍 1.&nbsp;构建 L3 交换机的教程都提供了什么内容？ 坦白地说，什么都没有。但是，如果您想学习如何从头开始构建我们自己的 Linux&nbsp;多层交换机/路由器，接下来的几个教程可能会对您...">
<link rel="dns-prefetch" href="//at.alicdn.com">
<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css?ver=6.6" type="text/css" media="all">
<style id="classic-theme-styles-inline-css" type="text/css">/*! This file is auto-generated */
.wp-block-button__link{color:#fff;background-color:#32373c;border-radius:9999px;box-shadow:none;text-decoration:none;padding:calc(.667em + 2px) calc(1.333em + 2px);font-size:1.125em}.wp-block-file__button{background:#32373c;color:#fff;text-decoration:none}</style>
<style id="global-styles-inline-css" type="text/css">:root{--wp--preset--aspect-ratio--square: 1;--wp--preset--aspect-ratio--4-3: 4/3;--wp--preset--aspect-ratio--3-4: 3/4;--wp--preset--aspect-ratio--3-2: 3/2;--wp--preset--aspect-ratio--2-3: 2/3;--wp--preset--aspect-ratio--16-9: 16/9;--wp--preset--aspect-ratio--9-16: 9/16;--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;--wp--preset--shadow--natural: 6px 6px 9px rgba(0, 0, 0, 0.2);--wp--preset--shadow--deep: 12px 12px 50px rgba(0, 0, 0, 0.4);--wp--preset--shadow--sharp: 6px 6px 0px rgba(0, 0, 0, 0.2);--wp--preset--shadow--outlined: 6px 6px 0px -3px rgba(255, 255, 255, 1), 6px 6px rgba(0, 0, 0, 1);--wp--preset--shadow--crisp: 6px 6px 0px rgba(0, 0, 0, 1);}:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flex{display: flex;}.is-layout-flex{flex-wrap: wrap;align-items: center;}.is-layout-flex > :is(*, div){margin: 0;}body .is-layout-grid{display: grid;}.is-layout-grid > :is(*, div){margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}
:root :where(.wp-block-pullquote){font-size: 1.5em;line-height: 1.6;}</style>
<link rel="stylesheet" id="cxm2-bootstrap-css" href="/wp-content/themes/meteor/assets/css/bootstrap.min.css?ver=1.2" type="text/css" media="all">
<link rel="stylesheet" id="cxm2-swiper-css" href="/wp-content/themes/meteor/assets/css/swiper-bundle.min.css?ver=1.2" type="text/css" media="all">
<link rel="stylesheet" id="cxm2-icons-css" href="//at.alicdn.com/t/c/font_1989294_lbwlt58uzfn.css?ver=1.2" type="text/css" media="all">
<link rel="stylesheet" id="cxm2-main-css" href="/wp-content/themes/meteor/style.css?ver=1.2" type="text/css" media="all">
<style id="cxm2-main-inline-css" type="text/css">:root, [data-bs-theme=light]{ --bs-link-hover-color:#fe4f70; --cbg-color:#fe5872; --cbg-gradient:var(--cx-gradient-rad); } [data-bs-theme=dark] { --bs-link-hover-color: #fe4f70; }</style>
<link rel="canonical" href="/archives/403">
</head>

<body class="post-template-default single single-post postid-403 single-format-standard cxtheme-body cxtheme-width-theme" x-data="MeteorData" :data-bs-theme="darkMode ? 'dark' : ''" :class="{'dark': darkMode,'overflow-y-hidden':popBgshow || searchPopup}">
    <div class="site-wrapper">
        <header class="header-s1" :class="{'onfixed' : searchPopup}">
            <div class="headnav">
                <div class="container-xl h-container">
                    <div class="cxlogo">
                                                <a href="/">
                            <img src="http://www.guozhiman.top/wp-content/uploads/2024/07/202406201718847016352278-1.png" alt="郭智满的部落！" class="c-light" width="120" height="60">
                            <img src="http://www.guozhiman.top/wp-content/uploads/2024/07/202406201718847016352278-2.png" alt="郭智满的部落！" class="c-dark" width="120" height="60">
                        </a>
                    </div>
                    <nav class="head-menu d-lg-flex">
                        <ul id="menu-main-menu" class="navbar-nav">
                        <li class="menu-item"><a href="/archives/category/meirifenxiang">每日分享</a></li>
<li class="menu-item"><a href="/archives/category/qianduan">前端</a></li>
<li class="menu-item"><a href="/archives/category/kaiyuan">开源</a></li>
<li class="menu-item"><a href="/archives/category/docker">Docker</a></li>
<li class="menu-item current-post-ancestor current-menu-parent"><a href="/archives/category/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0">技术文章</a></li>
<li class="menu-item"><a href="/archives/category/wangluoanquan">网络安全</a></li>
<li class="menu-item menu-has-children">
<a href="/archives/category/caozuoxitong">操作系统 <i class="cxicon cxicon-chevron-down menu-children-icon"></i></a>
<ul class="sub-menu">
	<li class="menu-item"><a href="/archives/category/caozuoxitong/windows">Win系统</a></li>
	<li class="menu-item"><a href="/archives/category/caozuoxitong/linuxunix">Linux/Unix</a></li>
	<li class="menu-item"><a href="/archives/category/caozuoxitong/guochanxitong">国产系统</a></li>
</ul>
</li>
                        </ul>
                    </nav>
                    <div class="header-r">
                        <ul class="h-btnbox sm-cnone">
                            <li class="list-inline-item">
                                <a href="/archives/403">
                                    <i class="cxicon cxicon-ranking"></i>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="javascript:;" @click="darkMode = !darkMode;localStorage.setItem('darkMode', darkMode);">
                                    <i class="cxicon cxicon-sunlight" :class="{'d-none':darkMode}"></i>
                                    <i class="cxicon cxicon-moon" :class="{'d-none':!darkMode}"></i>
                                </a>
                            </li>
                        </ul>
                        <div class="h-buttons">
                            <button type="button" class="search btn-default icon-button" @click="searchPopup = !searchPopup" title="Search Btn">
                                <i class="cxicon cxicon-search font-inherit" :class=" searchPopup ? 'cxicon-error' : 'cxicon-search'"></i>
                            </button>
                            <!-- 移动端菜单 -->
                            <button type="button" class="search btn-default icon-button" @click="moibleMenu = popBgshow = true" title="Menu Btn">
                                <i class="cxicon cxicon-menu3 font-inherit"></i>
                            </button>
                        </div>
                    </div>

                </div>
            </div>            
        </header><!-- header.end-->
        <!-- Moible Nav -->
        <div class="mobile-navbox trans_2ms" :class="{'visible': moibleMenu}">
            <button type="button" class="btn-close" aria-label="关闭" @click="popBgshow = moibleMenu = false"></button>
            <div class="m-menulogo p-4 pt-3"></div>
            <div class="m-navbox p-4 pt-0">
                <ul id="moible-menu" class="m-nav pe-4">
                <li class="menu-item"><a href="/archives/category/meirifenxiang">每日分享</a></li>
<li class="menu-item"><a href="/archives/category/qianduan">前端</a></li>
<li class="menu-item"><a href="/archives/category/kaiyuan">开源</a></li>
<li class="menu-item"><a href="/archives/category/docker">Docker</a></li>
<li class="menu-item current-post-ancestor current-menu-parent"><a href="/archives/category/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0">技术文章</a></li>
<li class="menu-item"><a href="/archives/category/wangluoanquan">网络安全</a></li>
<li class="menu-item menu-has-children">
<a href="/archives/category/caozuoxitong">操作系统 <i class="cxicon cxicon-chevron-down menu-children-icon"></i></a>
<ul class="sub-menu">
	<li class="menu-item"><a href="/archives/category/caozuoxitong/windows">Win系统</a></li>
	<li class="menu-item"><a href="/archives/category/caozuoxitong/linuxunix">Linux/Unix</a></li>
	<li class="menu-item"><a href="/archives/category/caozuoxitong/guochanxitong">国产系统</a></li>
</ul>
</li>
                </ul>
            </div>
        </div>
        <!-- MN.end -->
        

        <main class="main-container" role="main">
<div class="banner trem-banner mb-4">
    <div class="container-xl">
        
            <nav class="breadcrumbs" aria-label="面包屑导航">
                <ol class="breadcrumb flex-nowrap">
                
        <li class="item-home flex-shrink-0">
            <a href="/" title="郭智满的部落！">
                <span>首页</span>
            </a>
        </li>

        <li class="item-category flex-shrink-0">
            <a href="/archives/category/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0" title="技术文章">
                <span>技术文章</span>
            </a>
        </li>

        <li class="item-current line-one pe-4">
            <a href="/archives/403" title="在 x86 上构建 Linux L3 交换机/路由器">
                <span>在 x86 上构建 Linux L3 交换机/路由器</span>
            </a>
        </li>
                </ol>
            </nav>
                </div>
</div>
<!-- 3 -->
<section class="wi widget-coltow">
    <div class="container-xl">
        <div class="row cxrow">
            <div class="col-left">
                <div class="rowleft">
                    <div class="main-content pe-xl-4">
                        <article id="post-43" class="post is-single post-content status-publish" x-data="cxm2_Postmeta">
    <!-- 文章标题 -->
    <header class="post-header">
        <h1 class="post-title mt-3 mb-4 fs-2">在 x86 上构建 Linux L3 交换机/路由器</h1>        <!-- 文章元信息（如作者、发布时间、分类、标签等） -->
        <div class="article-meta">
<ul class="meta-itembox">
<li class="list-inline-item"><a class="author me-0" href="/archives/author/guozhiman"><figure class="figure-avatar  btn-default userid-1"><img alt="" src="http://cn.cravatar.com/avatar/740a87cfff4579440e19183a73f02b68?s=30&#038;d=mm&#038;r=g" srcset="http://cn.cravatar.com/avatar/740a87cfff4579440e19183a73f02b68?s=60&#038;d=mm&#038;r=g 2x" class="avatar avatar-30 photo" height="30" width="30" decoding="async"></figure>guozhiman</a></li>
<li class="list-inline-item"><a href="/archives/category/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0" rel="category tag">技术文章</a></li>
<li class="list-inline-item">2024年7月22日</li>
</ul>
</div>    </header>

    <!-- 文章正文 -->
    <div class="article-body mb-4">
        
<h1 class="wp-block-heading"><strong>第 1 部分 &#8211; 介绍</strong></h1>



<p><strong>1.&nbsp;</strong><strong>构建 L3 交换机的教程都提供了什么内容？</strong></p>



<p>坦白地说，什么都没有。但是，如果您想学习如何从头开始构建我们自己的 Linux&nbsp;多层交换机/路由器，接下来的几个教程可能会对您有所帮助。</p>



<p><strong>2.</strong><strong>&nbsp;</strong><strong>为什么我要花费时间阅读呢？</strong></p>



<p>首先，这是关于获取知识。即使您是一位经验丰富的 Linux 用户，其中也提到并解决了一些问题，因此您可以学到一些新东西。</p>



<p>其次，没有人强迫您阅读 😉</p>



<p><strong>3.&nbsp;</strong><strong>为什么不用 VyOS 等 Linux 路由器发行版？</strong></p>



<p>这也是您可以考虑的一个选项。VyOS 是一个带有自己操作系统的专业网络路由器发行版。运行它更多的是了解网络知识，而不是构建自己的 Linux 路由器。</p>



<p><strong>4.</strong>&nbsp;<strong>OK，你引起了我的注意。你的计划是什么？</strong></p>



<p>第 1 部分 &#8211; 简介、硬件和软件要求</p>



<p>第 2 部分 &#8211; CentOS 6.0 安装</p>



<p>第 3 部分 &#8211;&nbsp;无线接入点安装和配置</p>



<p>第 4 部分 &#8211; Openvswitch 安装和配置</p>



<p>第 5 部分 &#8211; 将盒子连接到互联网 &#8211; PPPoE 配置</p>



<p>第 6 部分 &#8211; 将盒子连接到互联网 &#8211; NAT 和防火墙配置</p>



<p>第 7 部分 &#8211; DDNS 和 NTP 服务器安装和配置</p>



<p>第 8 部分 &#8211; DNS 缓存服务器安装和配置</p>



<p>第 9 部分 &#8211; DHCP 服务器和 Samba 服务器安装和配置</p>



<p><strong>5.&nbsp;</strong><strong>最小硬件要求是什么？</strong><strong></strong></p>



<p>一台带有两个以太网卡和一个无线网卡的旧奔腾 III 应该就足够了。最小内存量为 512MB，硬盘为 20GB。我建议使用具有 1024MB 内存和两个 20GB 硬盘的计算机来创建 RAID-1 设备。为了有足够的端口供最终用户连接，应该有三个以太网卡 &#8211; 一个用于 WAN 连接，两个用于 LAN。由于我们要创建一个接入点，我们的无线网卡必须与 Linux 兼容，并且 Linux 驱动程序必须支持 AP 模式。请参考以下 URL 网络快捷方式：</p>



<p>&nbsp;&nbsp;&nbsp;&nbsp;Linux 无线局域网兼容性</p>



<p>&nbsp;&nbsp;&nbsp;&nbsp;无线网卡的 Linux 驱动程序</p>



<p><strong>6.</strong>&nbsp;<strong>你使用的是什么硬件？</strong><strong></strong></p>



<ul class="wp-block-list">
<li> CPU 英特尔奔腾 III &#8211; 733Mhz, 频率范围 [500 &#8211; 1000]MHz, 运行 733,6 Mhz (5,5 x 133,4 Mhz)</li>



<li>主板型号 &#8211; KOB 635T FSX主板芯片组
<ul class="wp-block-list">
<li> &#8211; SiS 635T</li>
</ul>
</li>



<li> 内存 &#8211; 2 x 512MB PC3200 DDR400 RAM 184 PIN NON ECC</li>



<li> 视频芯片组 &#8211; NVidia Riva TNT2 M64, 32MB</li>



<li>硬盘 &#8211;
<ul class="wp-block-list">
<li>ST380011A 80GB</li>



<li>ST3204231 20GB</li>
</ul>
</li>



<li> CD/DVD 光驱 &#8211; HL-DT-ST DVDRAM GSA-4163B</li>



<li>网络控制器 &#8211;
<ul class="wp-block-list">
<li>3 x Intel PRO/1000 MT 千兆桌面适配器 (82540EM)，</li>



<li>1 x D-Link DGE-528T 千兆以太网适配器，</li>



<li>1 x Broadcom BCM 4318 [Air Force One 54g] 802.1g 无线局域网控制器</li>
</ul>
</li>
</ul>



<p><strong>7.&nbsp;</strong><strong>如果我没有硬件可以玩怎么办？</strong></p>



<p>使用虚拟化软件代替真实硬件。有很多优秀的虚拟化 软件可供选择，如 Qemu、KVM 或 VirtualBox。选择其中一个并创建一个新的虚拟机。安装 GNS3 软件并将虚拟机导入到 GNS3 中。</p>



<p>GNS3 软件的一个很大的好处是，只需点击几下，您就可以创建一个由链接连接在一起的虚拟化节点的功能拓扑。GNS3 还允许您将拓扑连接到真实网络。</p>



<p>在实际版本 0.8.1 中，GNS3 支持 Dynamips、Qemu 和 VirtualBox 虚拟化器和模拟器。</p>



<p><strong>8.&nbsp;</strong><strong>我们要安装什么东西？</strong></p>



<ul class="wp-block-list">
<li>CentOS 6.0 &#8211; 带有软件 RAID-1</li>



<li>Linux 交换机 &#8211; Openvswitch 项目，1.2.0</li>



<li>无线软件接入点 &#8211; Hostapd，0.7.3</li>



<li>PPPoE 客户端 &#8211; pppd 2.4.5</li>



<li>NAT，防火墙 &#8211; iptables v1.4.7</li>



<li>DNS 服务器 &#8211; BIND 9.7.0</li>



<li>DHCP 服务器 &#8211; isc-dhcpd-4.1.1-P1</li>



<li>Samba 3.5.4-68</li>



<li>局域网 NTP 客户端/服务器 &#8211; 4.2.4p8</li>



<li>DDNS 客户端 &#8211; 3.8.1</li>
</ul>



<p><strong>9.&nbsp;</strong>“<strong>swouter”这个名字是什么意思？</strong></p>



<p>基本上，我将一个 Linux 盒子命名为“swouter”，因为它是具有路由功能的第 3 层交换机。</p>



<p><strong>10.&nbsp;</strong><strong>我还需要其他东西吗？</strong><strong></strong></p>



<p>不需要。但是互联网连接和你的耐心会很有帮助。</p>



<h1 class="wp-block-heading"><strong>第 2 部分 &#8211; CentOS 6.0 安装</strong></h1>



<p>这是描述在 Linux 上构建 Linux 第 3 层家庭交换机/路由器的分步教程系列中的第二篇。本教程展示了 CentOS 6.0 安装和软件 RAID 1 &#8211; 磁盘镜像配置。</p>



<p><strong>1.</strong>&nbsp;<strong>下载 CentOS-6.0-i386-minimal ISO 镜像</strong></p>



<p>选择离你位置最近的下载镜像。</p>



<p>$&nbsp;wget ftp://tux.rainside.sk/centos/6/isos/i386/CentOS-6.0-i386-minimal.iso</p>



<p><strong>2. 使用刻录软件 K3B 刻录 CD 映像</strong></p>



<p><strong>3. 设置计算机的 BIOS 从 CD 启动</strong></p>



<p><strong>4. 插入 CentOS 6 安装 CD</strong></p>



<p><strong>5. 从 CD 启动</strong></p>



<p>按回车键选择“安装或升级现有系统”选项。</p>



<p><strong>6. CD检查安装 CD</strong></p>



<p>CD 检查窗口出现。选择“OK”进行 CD 测试，或选择“Skip”跳过检查媒体并继续安装。</p>



<p><strong>7. CentOS 欢迎窗口</strong></p>



<p>当计算机为 CentOS 安装加载 X11 环境时，屏幕上会出现黑白文本，大约 30 秒后，我们将看到 CentOS GUI 安装程序，点击“下一步”。<em></em></p>



<p><strong>8. 选择安装过程中要使用的语言</strong></p>



<p><strong>9. 为系统选择键盘</strong></p>



<p><strong>10. 选择存储类型</strong></p>



<p>我们不使用任何特殊技术（iSCSI 或类似技术），因此选择“基本存储设备”选项。</p>



<p><strong>11. 设置主机名</strong></p>



<p><strong>12. 设置时区</strong></p>



<p><strong>13. 设置 root 密码</strong></p>



<p><strong>14. 选择安装类型</strong></p>



<p>只要我们想创建自己的分区布局，就选择“创建自定义布局”选项。</p>



<p><strong>15. “数据存储设备”/“安装目标设备”窗口</strong></p>



<p>只有在您有两个或更多硬盘驱动器时才会出现此窗口。我们安装了以下硬盘驱动器：</p>



<p>Model/Capacity</p>



<p>ATA ST320423A / 20GB</p>



<p>ATA ST380011A / 80GB</p>



<p>必须选择其中一个磁盘作为“安装目标设备”。该磁盘将被格式化，引导加载程序和操作系统将安装在磁盘上。我通过点击箭头按钮选择了两个磁盘作为安装目标设备。</p>



<p><strong>16. 分区</strong></p>



<p>我们将创建新的分区。我们的目标是创建软件 RAID 1 &#8211; 磁盘镜像。当 RAID 集中的一个磁盘出现故障时，另一个磁盘将继续工作。当更换故障磁盘时，数据将自动从幸存磁盘克隆到新磁盘。</p>



<p>Device | Size [MB] |</p>



<p>sda (/dev/sda/) 76319</p>



<p>Free</p>



<p>sdb (/dev/sdb/) 9536</p>



<p>Free</p>



<p>首先，在两个驱动器上创建两个大小相等的 RAID 分区。由于我们受到较小磁盘 /dev/sdb/ 容量的限制，每个 RAID 分区的大小将为 17GB。下一步是创建包含两个 RAID 分区的 RAID 设备 /dev/md0/。</p>



<p>CentOS 将安装在这个 RAID 设备上，挂载点为 /，使用 ext4 文件系统。</p>



<p>/dev/sdb/ 上剩余的 2535MB 将用于 SWAP 分区（2 倍于 RAM 的容量）。</p>



<p>必须在 /dev/sda/ 上创建相同容量的 SWAP 分区。</p>



<p>如果我们可以接受在 /dev/sda/ 出现故障时用户数据丢失的情况，那么 /dev/sda/ 上的剩余空间可以用于 /home 目录。</p>



<p>Device | Size [MB] | Mount Point/RAID/Volume | Type |</p>



<p>Raid Devices</p>



<p>md0 (dev/md0) 16998 / ext4</p>



<p>Hard Drives</p>



<p>sda (/dev/sda/)</p>



<p>sda1 17000 md0 software RAID</p>



<p>sda2 2535 swap</p>



<p>sda3 56783 /home ext4</p>



<p>sdb (/dev/sdb/)</p>



<p>sdb1 17000 md0 software RAID</p>



<p>sdb2 2535 swap</p>



<p>点击“Next”按钮。</p>



<p><strong>17.&nbsp;</strong><strong>Boot Loader modification</strong></p>



<p>这是我们可以更改用于引导加载程序安装的设备的最后一个地方。点击“Change Device”并选择 RAID 设备 &#8211; /dev/md0/。</p>



<p>点击“Next”。CentOS 安装映像将被传输到 RAID 设备上并从该设备进行安装。</p>



<p>注意：</p>



<p>如果 /dev/sda 出现故障，CentoOS 无法从 /dev/sdb/ 引导。它会尝试读取 /etc/fstab 中引用 /home 分区的条目。这个分区只存在于 /dev/sda 中，因此无法找到。在这种情况下，Linux 会给出一个“Repair Filesystem”提示，我们可以通过提供 root 密码进入。问题是在“Repair Filesystem”提示符下，文件系统被挂载为“只读”，因此我们无法从 /etc/fstab 中删除不再需要的 /home。</p>



<p>因此，我们需要以写权限重新挂载文件系统：</p>



<p>Repair filesystem #&nbsp;mount -w -o remount /</p>



<p>现在我们可以编辑 /etc/fstab 并删除或注释带有 /home 挂载的行。重新启动后，系统将正常启动。</p>



<p><strong>18. 更新系统</strong></p>



<p>我们现在已经安装了 CentOS。以 root 身份登录并更新整个系统。</p>



<p><strong>a)&nbsp;设置 IP 地址、默认网关、DNS</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;ifconfig eth3 172.18.100.150/16</p>



<p>[root@swouter-x86 ~]#&nbsp;route add default gw 172.18.100.1</p>



<p>[root@swouter-x86 ~]#&nbsp;echo &#8220;nameserver 172.18.100.1&#8221; &gt;&gt; /etc/resolv.conf</p>



<p><strong>b)&nbsp;更新系统</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;yum update -y</p>



<p><strong>c)&nbsp;修改文件 /etc/grub.conf</strong></p>



<p>变化：</p>



<p>&#8211; 注释掉旧的原始内核 &#8211; 2.6.32-71.el6.i686 的行。</p>



<p>&#8211; 注释掉参数 hiddenmenu，以便在启动时看到整个启动菜单。</p>



<p>&#8211; 将默认的 5 秒超时参数减少到 2 秒，以使 CentOS 更快地启动。</p>



<p><strong>问题：</strong></p>



<p>无法引导新内核 2.6.32071.29.1el6.i686。总是引导旧内核 2.6.32.-71.el6.i686。</p>



<p>[root@swouter-x86 ~]#&nbsp;dmesg | grep md</p>



<p>raid1: raid set md0 active with 1 out of 2 mirrors</p>



<p>md0: bitmap initialized from disk: read 1/1 pages, set 99 bits</p>



<p>created bitmap (1 pages) for device md0</p>



<p>md0: detected capacity change from 0 to&nbsp;17825718272</p>



<p>dracut: mdadm: /dev/md0 has been started with 1 drive (out of 2).</p>



<p>md0: detected capacity change from 0 to&nbsp;17825718272</p>



<p>md0: unknown partition table</p>



<p>dracut: mdadm: /dev/md0 is already in use.</p>



<p>EXT4-fs (md0): mounted filesystem with ordered data mode</p>



<p>dracut: Mounted root filesystem /dev/md0</p>



<p>SELinux: initialized (dev md0, type ext4), uses xattr</p>



<p>从 dmesg 的输出中我们可以看到 /dev/sda1 存在问题，它已被从阵列中踢出。让我们查询阵列状态。</p>



<p>[root@swouter-x86 ~]#&nbsp;cat /proc/mdstat</p>



<p>Personalities : [raid1]</p>



<p>md0 : active raid1 sdb1[1]</p>



<p>17407928 blocks super 1.0 [2/1] [_U]</p>



<p>bitmap: 1/1 pages [4KB], 65536KB chunk</p>



<p>unused devices: &lt;none&gt;</p>



<p>阵列中仅显示 sdb1，但阵列中应包含两个成员 [2/1]。我们需要检查 /dev/sda1 是否有故障。</p>



<p>[root@swouter-x86 ~]#&nbsp;fsck.ext4 /dev/sda1</p>



<p>e2fsck 1.41.12 (17-May-2010)</p>



<p>/dev/sda1: clean, 17651/1089536 files,&nbsp;234706/4351982&nbsp;blocks</p>



<p>当磁盘没有正确关闭时（UPS 故障等）可能会发生这种情况。将有问题的设备 /dev/sda1 读入阵列 /dev/md0 可能会有帮助。</p>



<p>[root@swouter-x86 ~]#&nbsp;/sbin/mdadm /dev/md0 &#8211;fail /dev/sda1 &#8211;remove /dev/sda1</p>



<p>[root@swouter-x86 ~]#/sbin/mdadm /dev/md0 &#8211;add /dev/sda1</p>



<p>现在，/dev/sda1 的内容正在从 /dev/sdb1 重建。</p>



<p>[root@swouter-x86 ~]#&nbsp;cat /proc/mdstat</p>



<p>Personalities : [raid1]</p>



<p>md0 : active raid1 sda1[0] sdb1[1]</p>



<p>17407928 blocks super 1.0 [2/1] [_U]</p>



<p>[&gt;&#8230;&#8230;&#8230;&#8230;&#8230;&#8230;..] recovery = 3.5% (625408/17407928) finish=31.2min speed=8944K/sec</p>



<p>bitmap: 1/1 pages [4KB], 65536KB chunk</p>



<p>unused devices: &lt;none&gt;</p>



<p>重建整个磁盘需要几分钟时间。完成后，再次检查阵列：</p>



<p>[root@swouter-x86 ~]#&nbsp;cat /proc/mdstat</p>



<p>Personalities : [raid1]</p>



<p>md0 : active raid1 sda1[0] sdb1[1]</p>



<p>17407928 blocks super 1.0 [2/2] [UU]</p>



<p>bitmap: 1/1 pages [4KB], 65536KB chunk</p>



<p>显然，现在 sda1 和 sdb1 分区都是 Raid 的成员了。重新启动并检查 dmesg 输出：</p>



<p>[root@swouter-x86 ~]#&nbsp;dmesg | grep md</p>



<p>ata1: PATA max UDMA/100 cmd 0x1f0 ctl 0x3f6 bmdma 0xff00 irq 14</p>



<p>ata2: PATA max UDMA/100 cmd 0x170 ctl 0x376 bmdma 0xff08 irq 15</p>



<p>md: md0 stopped.</p>



<p>md: bind&lt;sdb1&gt;</p>



<p>md: bind&lt;sda1&gt;</p>



<p>md: raid1 personality registered for level 1</p>



<p>raid1: raid set md0 active with 2 out of 2 mirrors</p>



<p>md0: bitmap initialized from disk: read 1/1 pages, set 0 bits</p>



<p>created bitmap (1 pages) for device md0</p>



<p>md0: detected capacity change from 0 to17825718272</p>



<p>dracut: mdadm: /dev/md0 has been started with 2 drives.</p>



<p>md0: detected capacity change from 0 to17825718272</p>



<p>md0: unknown partition table</p>



<p>EXT4-fs (md0): mounted filesystem with ordered data mode</p>



<p>dracut: Mounted root filesystem /dev/md0</p>



<p>SELinux: initialized (dev md0, type ext4), uses xattr</p>



<p><strong>19. 为控制台支持配置 CentOS</strong></p>



<p><strong>a)&nbsp;检查 dmesg 输出中是否存在串行端口</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;dmesg | grep tty</p>



<p>Console [tty0] enabled</p>



<p>serial8250: ttyS0 at I/O 0x3f8 (irq = 4) is a 16550A</p>



<p>serial8250: ttyS1 at I/O 0x2f8 (irq = 3) is a 16550A</p>



<p>我们有两个串行端口 &#8211; /dev/ttyS0 和 /dev/ttyS1</p>



<p><strong>b)&nbsp;配置 /etc/inittab 以支持串行控制台登录</strong></p>



<p>我们需要配置 agetty 守护进程来监听串行端口，它能够响应物理串行端口上的输入。</p>



<p>[root@swouter-x86 ~]#&nbsp;echo &#8220;S0:12345:respawn:/sbin/agetty ttyS0 9600 vt100&#8221; &gt;&gt; /etc/inittab</p>



<p>[root@swouter-x86 ~]#&nbsp;echo &#8220;S1:12345:respawn:/sbin/agetty ttyS1 9600 vt100&#8221; &gt;&gt; /etc/inittab</p>



<p>Explanation:</p>



<p>S0, S1 &#8211; 唯一标识符，可以是任意的。</p>



<p>12345 &#8211; 所有运行级别</p>



<p>0 &#8211; 停止（不要将 initdefault 设置为这个）</p>



<p>1 &#8211; 单用户模式</p>



<p>2 &#8211; 多用户，无 NFS（如果没有网络，则与 3 相同）</p>



<p>3 &#8211; 完全多用户模式</p>



<p>4 &#8211; 未使用</p>



<p>5 &#8211; X11</p>



<p>6 &#8211; 重启（不要将 initdefault 设置为这个）</p>



<p>respawn &#8211; 它将确保在你注销后它将接受另一个登录。</p>



<p>ttyS0, ttyS1 &#8211; 串行端口标识符</p>



<p>9600 &#8211; 串行线路速率（bps）</p>



<p>vt100 &#8211; 终端仿真。你可以使用其他的，但 VT100 是最常见的或“标准”的</p>



<p><strong>c)&nbsp;配置 /etc/securetty 以允许用户 root 在串行端口上登录</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;echo &#8220;ttyS0&#8221; &gt;&gt; /etc/securetty</p>



<p>[root@swouter-x86 ~]#&nbsp;echo &#8220;ttyS1&#8221; &gt;&gt; /etc/securetty</p>



<p><strong>d)&nbsp;编辑 /etc/sysconfig/init 并防止图形启动导致终端故障</strong></p>



<p>替换 BOOTUP=color 为 BOOTUP=serial</p>



<p>[root@swouter-x86 ~]#&nbsp;sed -i &#8216;s/BOOTUP=color/BOOTUP=serial/g&#8217; /etc/sysconfig/init</p>



<p><strong>e)&nbsp;编辑 /etc/grub.conf 将控制台输出重定向到串行端口 &#8211; /dev/ttyS0</strong></p>



<p>通过在行首放置 # 注释掉这两行：</p>



<p>#splashimage=(hd0,0)/grub/splash.xpm.gz</p>



<p>#hiddenmenu</p>



<p>在行首为“kernel”的行的末尾添加此行</p>



<p>console=ttyS0,9600n8</p>



<p><strong>End</strong><strong>.</strong></p>



<p>这是我在写作过程中密集使用的文章列表。</p>



<p>CentOS &nbsp;安装</p>



<p>http://aplawrence.com/Linux/lvm.html</p>



<p>Raid 理论</p>



<p>http://aplawrence.com/Linux/softmirror.html</p>



<p>http://aplawrence.com/Unixart/raid.html</p>



<p>http://www.linuxhomenetworking.com/wiki/index.php/Quick_HOWTO_:_Ch26_:_Linux_Software_RAID</p>



<p>e2fsck 和 e4fsck</p>



<p>http://unix.stackexchange.com/questions/18145/is-there-any-difference-between-e2fsck-and-e4fsck-on-centos-rhel-systems</p>



<p>恢复 Raid</p>



<p>http://www.linuxquestions.org/questions/linux-general-1/md-kicking-non-fresh-sda6-from-array-416853/</p>



<p>http://www.kieser.net/linux/raidhotadd.html</p>



<p>http://www.tgunkel.de/it/software/doc/linux_server.en</p>



<p>http://www.cyberciti.biz/faq/centos-rhel-linux-mount-raid-hard-disk-from-livecd/</p>



<p>Superblock 故障</p>



<p>http://ubuntuforums.org/showthread.php?t=1245536</p>



<p>http://ubuntuforums.org/archive/index.php/t-1245536.html</p>



<p>http://www.unix.com/unix-advanced-expert-users/78965-linux-ext3-superblock-recovery.html</p>



<p>Linux 控制台支持</p>



<p>http://www.vanemery.com/Linux/Serial/serial-console.html</p>



<p>http://www.ghidinelli.com/2006/11/06/configuring-console-access-for-linuxcentos</p>



<h1 class="wp-block-heading"><strong>第 3 部分 &#8211; 无线接入点安装与配置</strong></h1>



<p>我们将通过另一个教程继续构建我们的 Linux 第 3 层交换机，该教程解释了为无线局域网用户安装和配置安全无线接入点（AP）的步骤。AP 将被配置为使用安全的 WPA2 协议进行客户端身份验证，并使用预共享密钥（PSK）。AP 和客户端之间的流量将使用现代 AES 加密进行加密。描述 Linux L3 交换机/路由器概念、硬件和软件要求的介绍教程在这里。</p>



<p><strong>1. 安装 pciutils</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;yum install pciutils</p>



<p><strong>2. 获取有关无线以太网卡的信息</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;lspci -vnn</p>



<p>&lt;Output is truncated&gt;</p>



<p>00:11.0 Network controller [0280]: Broadcom Corporation BCM4318 [AirForce One 54g] 802.11g Wireless LAN Controller [14e4:4318] (rev 02)</p>



<p>Subsystem: ASUSTeK Computer Inc. WL-138G v2 / WL-138gE / WL-100gE [1043:100f]</p>



<p>Flags: bus master, fast devsel, latency 64, IRQ 5</p>



<p>Memory at dfffa000 (32-bit, non-prefetchable) [size=8K]</p>



<p>Kernel driver in use: b43-pci-bridge</p>



<p>Kernel modules: ssb</p>



<p>&lt;Output is truncated&gt;</p>



<p>我们可以看到芯片组 BCM4318 已被识别，并且内核驱动程序 b43 正在使用中。现在将双括号中的输出 &#8211; [14e4:4318] 与支持的硬件芯片组列表进行比较。</p>



<p>我们可以看到 BCM4318 是受支持的，并且 b/g 模式可用。尽管 b43 驱动程序支持 AP 模式（查看功能部分），但该网站告诉我们：</p>



<blockquote class="wp-block-quote is-layout-flow wp-block-quote-is-layout-flow">
<p>BCM4318 芯片组有这个已知问题：由于高传输速率下的数据包丢失，AP 模式无法正常工作。我们稍后会进行测试。</p>
</blockquote>



<p>这些是其他有助于故障排除的输出。</p>



<p>[root@swouter-x86 ~]#&nbsp;dmesg</p>



<p>&lt;Output is truncated&gt;</p>



<p>b43-phy0: Broadcom 4318 WLAN found (core revision 9)</p>



<p>b43-phy0 debug: Found PHY: Analog 3, Type 2, Revision 7</p>



<p>b43-phy0 debug: Found Radio: Manuf 0x17F, Versionwebsite 0x2050, Revision 8</p>



<p>phy0: Selected rate control algorithm &#8216;minstrel&#8217;</p>



<p>Registered led device: b43-phy0::tx</p>



<p>Registered led device: b43-phy0::rx</p>



<p>Registered led device: b43-phy0::assoc</p>



<p>Registered led device: b43-phy0::radio</p>



<p>Broadcom 43xx driver loaded [ Features: PMLS, Firmware-ID: FW13 ]</p>



<p>&lt;Output is truncated&gt;</p>



<p>[root@swouter-x86 ~]#&nbsp;lsmod | grep b43</p>



<p>b43 181773 0</p>



<p>mac80211 129050 1 b43</p>



<p>cfg80211 118045 2 b43,mac80211</p>



<p>ssb 47878 1 b43</p>



<p>mmc_core 61320 2 b43,ssb</p>



<p><strong>3. 芯片组 BCM4318 的设备固件安装</strong></p>



<p>根据链接，Broadcom 无线芯片需要在无线芯片本身上运行的专有软件（称为“固件”）才能正常工作。此固件受 Broadcom 版权保护，必须从 Broadcom 的专有驱动程序中提取。要在我们的系统上获取此类固件，我们必须从合法的分发点下载驱动程序，提取并安装它。</p>



<p>&nbsp;<strong>a/&nbsp;安装 b43-fwcutter</strong></p>



<p>如果我们想使用最新的 Broadcom 固件 5.10.56.27.3，我们必须使用 b43-fwcutter. 版本 014。CentOS 存储库仅提供 b43-fwcuter 版本 012，该版本仅支持高达 4.150.10.5 版本的固件。因此，我们需要从源代码编译并安装 b43-fwcutter。</p>



<p>http://wireless.kernel.org/en/users/Drivers/b43#other_distros</p>



<p>[root@swouter-x86 ~]#&nbsp;yum install wget make kernel-headers gcc</p>



<p>[root@swouter-x86 ~]#&nbsp;wget http://bu3sch.de/b43/fwcutter/b43-fwcutter-014.tar.bz2</p>



<p>[root@swouter-x86 ~]#&nbsp;tar xjf b43-fwcutter-014.tar.bz2</p>



<p>[root@swouter-x86 ~]#&nbsp;cd b43-fwcutter-014</p>



<p>[root@swouter-x86 ~]#&nbsp;make</p>



<p>[root@swouter-x86 ~]#&nbsp;make install</p>



<p>检查 fw-cutter 是否正确安装：</p>



<p>[root@swouter-x86 b43-fwcutter-014]#&nbsp;<code>/usr/local/bin/b43-fwcutter --help</code></p>



<p>b43-fwcutter version 014</p>



<p><strong>b/&nbsp;将固件提取到 /lib/firmware</strong></p>



<p>root@swouter-x86 ~]#&nbsp;<code>export FIRMWARE_INSTALL_DIR="/lib/firmware"</code></p>



<p>[root@swouter-x86 ~]#&nbsp;wget http://mirror2.openwrt.org/sources/broadcom-wl-5.10.56.27.3_mipsel.tar.bz2</p>



<p>[root@swouter-x86 ~]#&nbsp;tar jxvf broadcom-wl-5.10.56.27.3_mipsel.tar.bz2</p>



<p>[root@swouter-x86 ~]#&nbsp;/usr/local/bin/b43-fwcutter -w &#8220;$FIRMWARE_INSTALL_DIR&#8221; broadcom-wl-5.10.56.27.3/driver/wl_apsta/wl_prebuilt.o</p>



<p>固件正在安装到 /lib/firmware/b43 目录中。</p>



<p><strong>4. 安装 wireless-tools</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;yum install wireless-tools.i686</p>



<p><strong>5. 测试</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;iwconfig wlan0 mode Master</p>



<p>Error for wireless request &#8220;Set Mode&#8221; (8B06) :</p>



<p>SET failed on device wlan0 ; Invalid argument.</p>



<p>乍一看，似乎不支持主模式。根据这个链接，b43 驱动程序应该允许我们创建 AP。因此，我们需要安装 hostapd 实用程序，它允许我们将无线网卡切换到主模式。</p>



<p><strong>6. 安装 Hostapd</strong></p>



<p><strong>a)&nbsp;安装 hostapd 编译所需的必要软件包，并获取最新版本的 hostapd</strong></p>



<p>[root@swouter-x86 hostapd]#&nbsp;yum install glibc libnl.i686 libnl-devel.i686 openssl-devel</p>



<p>[root@swouter-x86 ~]#&nbsp;wget http://w1.fi/releases/hostapd-0.7.3.tar.gz</p>



<p>[root@swouter-x86 ~]#&nbsp;tar zxvf hostapd-0.7.3.tar.gz</p>



<p>[root@swouter-x86 ~]#&nbsp;cd hostapd-0.7.3/hostapd/</p>



<p><strong>b)&nbsp;创建配置文件并启用NL80211支持</strong></p>



<p>[root@swouter-x86 hostapd]#&nbsp;cp defconfig .config</p>



<p>[root@swouter-x86 hostapd]#&nbsp;vi .config</p>



<p>现在找到包含以下配置的行：</p>



<p>#CONFIG_DRIVER_NL80211=y</p>



<p>通过删除“#”符号取消注释该行。对您可能感兴趣的其他设置重复此操作。基本配置（仅取消注释此行）足以使 hostapd 启动并运行 WPA/WPA2 身份验证和加密。</p>



<p><strong>c)&nbsp;编译hostapd并保存到/usr/local/bin/目录</strong></p>



<p>[root@swouter-x86 hostapd]#&nbsp;make</p>



<p>[root@swouter-x86 hostapd]#&nbsp;cp ./hostapd /usr/local/bin/</p>



<p><strong>d)&nbsp;为 hostapd 创建配置文件</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;vim /etc/hostapd.conf</p>



<p>interface=wlan0</p>



<p>driver=nl80211</p>



<p>ssid=Swouter-x86-wlan</p>



<p>channel=1</p>



<p>hw_mode=g</p>



<p>wpa=2</p>



<p>wpa_key_mgmt=WPA-PSK</p>



<p>wpa_pairwise=CCMP</p>



<p>wpa_passphrase=your_password</p>



<p><strong>e)&nbsp;为 hostapd 制作初始化脚本</strong></p>



<p>我们可以使用该网站的脚本：</p>



<p>#!/bin/sh</p>



<p><code>#start/stop the hostapd server</code></p>



<p>#</p>



<p><code># chkconfig: 2345 99 10</code></p>



<p><code># description: hostap daemon</code></p>



<p><code># processname: hostapd</code></p>



<p><code># config: /etc/hostapd.conf</code></p>



<p><code># pidfile: /var/run/hostapd.pid</code></p>



<p><code>#</code></p>



<p><code>PATH=/bin:/usr/bin:/usr/local/bin:/sbin:/usr/sbin</code></p>



<p><code>export PATH</code></p>



<p># Source function library.</p>



<p><code>. /etc/rc.d/init.d/functions</code></p>



<p>stop()</p>



<p><code>{</code></p>



<p><code>echo -n "Stopping hostapd daemon: "</code></p>



<p><code>killproc hostapd</code></p>



<p><code>echo</code></p>



<p><code>rm -f /var/lock/subsys/hostapd</code></p>



<p><code>}</code></p>



<p>start()</p>



<p><code>{</code></p>



<p><code>echo -n "Starting hostapd daemon: "</code></p>



<p><code>daemon /usr/local/bin/hostapd /etc/hostapd.conf -P /var/run/hostapd.pid -B</code></p>



<p><code>echo</code></p>



<p><code>touch /var/lock/subsys/hostapd</code></p>



<p><code>}</code></p>



<p># See how we were called.</p>



<p><code>case "$1" in</code></p>



<p><code>start)</code></p>



<p><code>start</code></p>



<p><code>;;</code></p>



<p><code>stop)</code></p>



<p><code>stop</code></p>



<p><code>;;</code></p>



<p><code>status)</code></p>



<p><code>status hostapd</code></p>



<p><code>;;</code></p>



<p><code>restart)</code></p>



<p><code>stop</code></p>



<p><code>start</code></p>



<p><code>;;</code></p>



<p><code>*)</code></p>



<p>echo &#8220;Usage: hostapd {start|stop|status|restart}&#8221;</p>



<p><code>exit 1</code></p>



<p><code>esac</code></p>



<p><code>exit 0</code></p>



<p>创建 /etc/init.d/hostapd 文件并将脚本复制到该文件。为该文件分配运行权限。</p>



<p>[root@swouter-x86 ~]#&nbsp;chmod +x /etc/init.d/hostapd<strong></strong></p>



<p><strong>f)&nbsp;配置一个在所有运行级别重启后启动的初始化脚本</strong></p>



<p>root@swouter-x86 ~]#&nbsp;<code>chkconfig --add hostapd</code></p>



<p><strong>g)&nbsp;测试</strong></p>



<p>连接到 AP 的客户端的输出。注意“无效杂项”计数器。</p>



<p>[brezular@COM-8510p ~]$&nbsp;iwconfig wlan0</p>



<p>wlan0 IEEE 802.11abgn ESSID:&#8221;Swouter-x86-wlan&#8221;</p>



<p>Mode:Managed Frequency:2.432 GHz Access Point: 00:17:31:CE:6A:CF</p>



<p>Bit Rate=54 Mb/s Tx-Power=15 dBm</p>



<p>Retry long limit:7 RTS thr:off Fragment thr:off</p>



<p>Power Management:off</p>



<p>Link Quality=70/70 Signal level=-31 dBm</p>



<p>Rx invalid nwid:0 Rx invalid crypt:0 Rx invalid frag:0</p>



<p>Tx excessive retries:0 Invalid misc:247 Missed beacon:0</p>



<p>根据：http://linux.die.net/man/8/iwconfig &#8211; 此计数器表示与特定无线操作相关的数据包丢失。即使计数器正在缓慢增加，也没有任何明显的数据包丢失，这阻止了我们使用此无线网卡。</p>



<p>以下是我在写作过程中大量使用的文章列表。</p>



<p>http://wireless.kernel.org/en/users/Drivers/b43#devicefirmware</p>



<p>http://wiki.centos.org/HowTos/Laptops/Wireless</p>



<p>http://wiki.centos.org/HowTos/Laptops/Wireless/Broadcom?action=show</p>



<p>http://forums.opensuse.org/english/get-technical-help-here/wireless/410165-creating-access-point-11-1-a.html</p>



<p>http://linuxwireless.org/en/users/Documentation/hostapd#Download_and_compile_hostapd</p>



<p>http://linuxwireless.org/en/users/Drivers</p>



<p>http://djlab.com/2010/02/basic-hostapd-init-script-for-redhatcentos-variants/</p>



<p>http://linux.die.net/man/8/iwconfig</p>



<h1 class="wp-block-heading"><strong>第 4 部分 &#8211; Openvswitch 安装和配置</strong></h1>



<p>在上一篇教程中，我们将 Linux 第 3 层交换机切换为无线主模式，以便为无线 LAN 用户提供无线服务。我们将继续构建 Linux L3 交换机并在 CentOS 上安装 Open vSwitch 以连接有线 LAN 用户。入门教程、软件和硬件要求列表在此处。</p>



<p>尽管有多个项目可以帮助我们将以太网接口桥接在一起并强制 Linux 机器充当交换机（VDEswitch、LiSA 或桥接实用程序），但我想使用 Openvswitch 来完成这项工作，因为它提供了许多可以在硬件交换机中找到的功能。</p>



<p>它们是 PCI 插槽中的四块千兆以太网卡。其中三块是 Intel e1000 &#8211; 82540EM 千兆控制器，一块是 D-Link System DGE-528T 控制器。还有 Broadcom BCM4318 802.11g 无线局域网控制器，用于连接无线局域网用户，如我们在此处所示。</p>



<p>我们将使用 DGE-528T 千兆控制器将我们的 Linux 机箱连接到互联网。此接口的 IP 地址将由提供商的 DHCP 服务器自动分配。</p>



<p>其余三个 Intel e1000 千兆控制器和一个无线控制器将桥接在一起，并根据目标以太网地址（而不是 IP 地址）在这些接口之间转发流量。连接到这些端口的计算机属于同一 IP 子网 &#8211; 172.18.0.0/16 。</p>



<p>还必须创建虚拟接口并配置其 IP 地址 &#8211; 172.18.100.150/16。该 IP 地址用作子网 172.18.0.0/16 上所有主机的默认网关 IP 地址。如果目标 IP 地址超出其子网范围，则所有计算机都会将流量转发到此 IP 地址。</p>



<p><strong>1. 检查 8021q 和桥接模块是否已加载</strong></p>



<p>$&nbsp;sudo su</p>



<p>#&nbsp;lsmod | grep 8021q</p>



<p>8021q 19587 0</p>



<p>garp 5901 1 8021q</p>



<p>如果 8021q 模块未加载，请使用 modprobe 8021q 命令将模块加载到内核。</p>



<p>Open vSwitch 数据路径需要将桥接支持 (CONFIG_BRIDGE) 构建为内核模块。桥接模块不得加载或使用。</p>



<p>#&nbsp;lsmod | grep bridge</p>



<p>bridge 61159 0</p>



<p>stp 1563 2 bridge,garp</p>



<p>llc 4392 3 bridge,garp,stp</p>



<p>在这种情况下，桥接模块正在运行，我们必须将其移除。</p>



<p>#&nbsp;rmmod bridge</p>



<p><strong>2. 下载 Openvswitch 并解压</strong></p>



<p>#&nbsp;wget http://openvswitch.org/releases/openvswitch-1.2.0.tar.gz</p>



<p>#&nbsp;tar zxvf ./openvswitch-1.2.0.tar.gz</p>



<p><strong>3. 安装 Open Vswitch 编译所需的依赖项</strong></p>



<p>#<strong>&nbsp;</strong>yum install python PyQt4 python-zope-interface python-twisted-conch python-simplejson perl kernel-devel<strong></strong></p>



<p><strong>4. Openvswitch 安装重启后</strong></p>



<p>#&nbsp;cd ./openvswitch-1.2.0</p>



<p>#&nbsp;./configure &#8211;with-linux=/lib/modules/`uname -r`/build</p>



<p>#&nbsp;make</p>



<p>#&nbsp;make install</p>



<p><strong>5. 加载Openvswitch内核模块</strong></p>



<p>编译完成后，./datapath/linux/directory下会保存一个内核模块openvswitch_mod_ko，我们可以尝试用insmod命令将其加载到Linux内核中。</p>



<p>#&nbsp;insmod ./datapath/linux/openvswitch_mod.ko</p>



<p>检查模块是否已加载：</p>



<p>#&nbsp;lsmod | grep openvswitch_mod</p>



<p>openvswitch_mod 67954 0</p>



<p><strong>6. 加载 openvswitch 内核模块并使其在启动时加载</strong></p>



<p>即使可以使用 insmod 命令将模块加载到内核，也无法使用 modprobe 命令加载。我们将修复此问题。</p>



<p><strong>a)&nbsp;从内核卸载模块并将其复制到标准位置</strong></p>



<p>#&nbsp;rmmod openvswitch_mod</p>



<p>#&nbsp;mkdir /lib/modules/2.6.32-71.29.1.el6.i686/kernel/net/openvswitch/</p>



<p>#&nbsp;cp ./datapath/linux/openvswitch_mod.ko /lib/modules/2.6.32-71.29.1.el6.i686/kernel/net/openvswitch/</p>



<p><strong>b)&nbsp;创建依赖项列表并将其写入 /lib/modules/`uname -r`/modules.dep</strong></p>



<p>#&nbsp;depmod -a</p>



<p><strong>c)&nbsp;使用 modprobe 命令加载模块</strong></p>



<p>#&nbsp;modprobe openvswitch_mod</p>



<p><strong>d)&nbsp;使模块在重启后加载</strong></p>



<p>我们需要创建一个简单的脚本，存储在文件 /etc/sysconfig/modules 中。如果模块尚未加载，则脚本会加载该模块。</p>



<p>#&nbsp;touch /etc/sysconfig/modules/openvswitch.modules</p>



<p>#&nbsp;chmod 755 /etc/sysconfig/modules/openvswitch.modules</p>



<p>#&nbsp;vi /etc/sysconfig/modules/openvswitch.modules</p>



<p>#!/bin/sh</p>



<p>if [ $(grep -c openvswitch_mod /proc/modules) -eq 0 ]; then</p>



<p>modprobe -b openvswitch_mod &gt; /dev/null 2&gt;&amp;1</p>



<p>fi</p>



<p>如果 grep 返回值 0，则表示模块 openvswitch_mod.ko 未加载，将由 modprobe 命令加载。</p>



<p><strong>e)&nbsp;检查 RAID 设备是否正常工作</strong></p>



<p>检查 RAID 的状态。如果磁盘 /dev/sda1 和 /dev/sdb1 有问题，请将设备读取到 /dev/md0。这在 CentOS 安装中已经显示过。</p>



<p><strong>7. 使用 ovsdb-tool 初始化配置数据库</strong></p>



<p>#&nbsp;mkdir -p /usr/local/etc/openvswitch</p>



<p>#&nbsp;ovsdb-tool create /usr/local/etc/openvswitch/conf.db vswitchd/vswitch.ovsschema</p>



<p><strong>8.&nbsp;</strong><strong>启动配置数据库 ovsdb-server 并使其在启动时启动</strong><strong></strong></p>



<p>#&nbsp;/usr/local/sbin/ovsdb-server /usr/local/etc/openvswitch/conf.db&nbsp;</p>



<p>&#8211;remote=punix:/usr/local/var/run/openvswitch/db.sock&nbsp;</p>



<p>&#8211;remote=db:Open_vSwitch,manager_options&nbsp;</p>



<p>&#8211;private-key=db:SSL,private_key&nbsp;</p>



<p>&#8211;certificate=db:SSL,certificate&nbsp;</p>



<p>&#8211;bootstrap-ca-cert=db:SSL,ca_cert&nbsp;</p>



<p>&#8211;pidfile &#8211;detach</p>



<p>要在启动期间启动数据库，您需要将这些行复制到 /etc/rc.local。<em></em></p>



<p><strong>注意</strong>&nbsp; 由于该命令是单个命令，因此请不要将其放在单独的行上。</p>



<p><strong>9. 使用 ovs-vsctl 初始化数据库并在启动期间初始化它</strong></p>



<p>这仅在您使用 ovsdb-tool 创建数据库后第一次运行才是必要的（但在任何时候运行它都是无害的）。</p>



<p>#&nbsp;/usr/local/bin/ovs-vsctl &#8211;no-wait init</p>



<p>#&nbsp;echo &#8220;/usr/local/sbin/ovs-vsctl &#8211;no-wait init&#8221; &gt;&gt; /etc/rc.local</p>



<p><strong>10. 启动主 Open vSwitch 守护进程，告诉它连接到同一个 Unix 域套接字并在启动期间启动守护进程</strong></p>



<p>#&nbsp;/usr/local/sbin/ovs-vswitchd unix:/usr/local/var/run/openvswitch/db.sock &#8211;pidfile &#8211;detach</p>



<p>#&nbsp;echo &#8220;/usr/local/sbin/ovs-vswitchd unix:/usr/local/var/run/openvswitch/db.sock &#8211;pidfile &#8211;detach&#8221; &gt;&gt; /etc/rc.local</p>



<p><strong>11. 启用接口之间的 IPv4 和 IPV6 数据包转发</strong></p>



<p>虽然与 Openvswitch 配置无关，但我们需要启用接口之间的 ipv4 和 ipv6 数据包转发。默认情况下，这些选项是禁用的。</p>



<p>#&nbsp;sysctl -w net.ipv4.ip_forward=1</p>



<p>#&nbsp;sysctl -w net.ipv6.conf.all.forwarding=1</p>



<p>要在启动时启用转发，您需要编辑 /etc/sysctl.conf 并更改/添加以下行。</p>



<p>net.ipv4.ip_forward=1</p>



<p>net.ipv6.conf.default.forwarding=1</p>



<p><strong>12. Openvswitch 配置-创建网桥 br0，向网桥添加接口</strong></p>



<p><strong>a)&nbsp;创建网桥 br0</strong></p>



<p><strong>#&nbsp;</strong>ovs-vsctl add-br br0</p>



<p><strong>b)&nbsp;将端口 eth0-eth2、wlan0 添加到网桥</strong></p>



<p>#&nbsp;ovs-vsctl add-port br0 eth0</p>



<p>#&nbsp;ovs-vsctl add-port br0 eth1</p>



<p>#&nbsp;ovs-vsctl add-port br0 eth2</p>



<p>#&nbsp;ovs-vsctl add-port br0 wlan0</p>



<p><strong>c)&nbsp;创建 L3 vlan1 虚拟接口</strong></p>



<p>#&nbsp;ovs-vsctl add-port br0 vlan1 &#8212; set interface vlan1 type=internal</p>



<p>检查 vlan1 是否存在，启动桥接接口</p>



<p>#&nbsp;ifconfig vlan1</p>



<p>vlan1 Link encap:Ethernet HWaddr 00:23:20:80:C9:A2</p>



<p>BROADCAST MULTICAST MTU:1500 Metric:1</p>



<p>RX packets:0 errors:0 dropped:0 overruns:0 frame:0</p>



<p>TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</p>



<p>collisions:0 txqueuelen:0</p>



<p>RX bytes:0 (0.0 b) TX bytes:0 (0.0 b)</p>



<p>#&nbsp;ifconfig vlan1 up</p>



<p>#&nbsp;ifconfig eth0 up</p>



<p>#&nbsp;ifconfig eth1 up</p>



<p>#&nbsp;ifconfig eth2 up</p>



<p>#&nbsp;ifconfig wlan0 up</p>



<p>要在启动过程中启动接口，您需要将 /etc/sysconfig/network-scripts/ 中每个 ifcfg-ethx 脚本的参数 ONBOOT=&#8221;no&#8221; 更改为 ONBOOT=&#8221;yes&#8221;。对所有以太网接口执行此操作。</p>



<p>#&nbsp;sed -i &#8216;s/ONBOOT=&#8221;no&#8221;/ONBOOT=&#8221;yes&#8221;/g&#8217; /etc/sysconfig/network-scripts/ifcfg-eth0</p>



<p>#&nbsp;sed -i &#8216;s/ONBOOT=&#8221;no&#8221;/ONBOOT=&#8221;yes&#8221;/g&#8217; /etc/sysconfig/network-scripts/ifcfg-eth1</p>



<p>#&nbsp;sed -i &#8216;s/ONBOOT=&#8221;no&#8221;/ONBOOT=&#8221;yes&#8221;/g&#8217; /etc/sysconfig/network-scripts/ifcfg-eth2</p>



<p>#&nbsp;sed -i &#8216;s/ONBOOT=&#8221;no&#8221;/ONBOOT=&#8221;yes&#8221;/g&#8217; /etc/sysconfig/network-scripts/ifcfg-eth3</p>



<p>#&nbsp;sed -i &#8216;s/ONBOOT=&#8221;no&#8221;/ONBOOT=&#8221;yes&#8221;/g&#8217; /etc/sysconfig/network-scripts/ifcfg-wlan0</p>



<p><strong>d)&nbsp;使vlan1接口的IP地址在重启后保留</strong></p>



<p>#&nbsp;vi /etc/sysconfig/network-scripts/ifcfg-vlan1</p>



<p>DEVICE=vlan1</p>



<p>ONBOOT=yes</p>



<p>BOOTPROTO=static</p>



<p>IPADDR=172.18.100.150</p>



<p>NETMASK=255.255.0.0</p>



<p><strong>13. 创建 Openvswitch 初始化脚本</strong></p>



<p>当 Openvswitch 在 OS 启动期间启动时，它会读取自己的数据库并创建 vlan1 接口。为此，我们必须创建一个 init 脚本，以便在初始化网络接口之前启动 openvswitch。为了实现这一点，我们必须将 openvswitch 的启动优先级设置为低于网络优先级 S=10 的 S=9。</p>



<p><strong>a)&nbsp;创建启动脚本 /etc/init.d/openvswitchd</strong></p>



<p>#&nbsp;&nbsp;vi /etc/init.d/openvswitchd</p>



<p><strong>b)&nbsp;配置 Openvswitch 脚本以在启动时启动</strong></p>



<p>#&nbsp;chmod 755 /etc/init.d/openvswitchd</p>



<p>#&nbsp;chkconfig &#8211;add openvswitchd</p>



<p>#&nbsp;chkconfig openvswitchd on&nbsp;</p>



<p><strong>End.</strong></p>



<h1 class="wp-block-heading"><strong>第 5 部分 &#8211; 将盒子连接到互联网 &#8211; PPPoE 配置</strong></h1>



<p>到目前为止，我们已经在计算机上安装了 Linux CentOS，为无线用户连接创建了接入点，并配置了 Open vSwitch 来连接有线 LAN 用户。现在是时候继续前进，将我们的 Linux L3 交换机连接到互联网了。为此，我们必须安装和配置 PPPoE。</p>



<p>PPPoE 代表以太网上的点对点，它是一种第 2 层网络协议，将 PPP 帧封装在以太网帧内。我们的 Linux L3 交换机（路由器）代表 PPPoE 客户端，并向 PPPoE 服务器提交登录凭据。PPPoE 服务器位于 ISP 网络上，并为客户端提供身份验证服务。</p>



<p><strong>1. 在启动时将路由接口 Ethernet3 置于启动状态</strong></p>



<p>我们将使用 D-Link DGE-528T 千兆以太网适配器 &#8211; 其显示为以太网 3 接口，用于 WAN 连接。接口必须在启动时启动，因此我们必须在 /etc/sysconfig/network-scripts/ifcfg-eth3configuration 中将参数 ONBOOT=&#8221;no&#8221; 更改为 ONBOOT=&#8221;yes&#8221;。</p>



<p>[root@swouter-x86 ~]#&nbsp;<code>sed -i 's/ONBOOT="no"/ONBOOT="yes"/g' /etc/sysconfig/network-scripts/ifcfg-eth3</code></p>



<p><strong>2.&nbsp; 加载pppoe模块到内核</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;modprobe pppoe</p>



<p>如果 pppoe 模块无法加载到内核，请检查此链接以供参考。</p>



<p><strong>3. 安装 ppp 并配置登录凭据</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;yum install ppp.i686<strong></strong></p>



<p>登录凭据存储在文件 /etc/ppp/chap-secrets 中。如果我们使用 pppd 进行多个连接，则需要引入唯一 ID 以及登录名和密码。下面的示例将用户 brezular 及其 ID my_ID 和密码 my_password 添加到文件 /etc/ppp/chap-secrets 中。</p>



<p>[root@swouter-x86 ~]#&nbsp;<code>echo "brezular my_ID my_password" &gt;&gt; /etc/ppp/chap-secrets</code></p>



<p><strong>4. 在 /etc/ppp/peers/ 目录中创建配置文件 my_ISP</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;vi /etc/ppp/peers/my_ISP</p>



<p>plugin rp-pppoe.so</p>



<p># 我们通过其接收 pppoe 的网络接口</p>



<p>eth3</p>



<p># 用户名 &#8211; 与 /etc/ppp/chap-secret 中的相同</p>



<p>user brezular</p>



<p># 使用 ISP 提供商的 IP 地址</p>



<p>noipdefault</p>



<p># 使用提供商的 DNS 服务器</p>



<p>usepeerdns</p>



<p>chmod 755 /etc/ppp/ip-up.local</p>



<p># 固定连接</p>



<p>persist</p>



<p># 提供商的路由器将用作网关</p>



<p>defaultroute</p>



<p># 来自 chap-secrets 的唯一 ID</p>



<p>remotename my_ID</p>



<p><strong>5. 启动 pppd</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;/usr/sbin/pppd call my_ISP</p>



<p>显示文件 /var/log/messages 的内容来查找日志消息。</p>



<p>[root@swouter-x86 ~]#&nbsp;tail -n 14 /var/log/messages</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2148]: Plugin rp-pppoe.so loaded.</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2148]: RP-PPPoE plugin version 3.8p compiled against pppd 5</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2149]: pppd 2.4.5 started by root, uid 0</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2149]: PPP session is 12411</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2149]: Connected to 00:90:1a:42:14:05 via interface eth3</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2149]: Using interface ppp0</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2149]: Connect: ppp0 &lt;&#8211;&gt; eth3</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2149]: CHAP authentication succeeded: CHAP authentication 9</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2149]: CHAP authentication succeeded</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2149]: peer from calling number 00:90:1A:42:14:05 authorizd</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2149]: local IP address 91.127.65.93</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2149]: remote IP address 213.81.232.247</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2149]: primary DNS address 195.146.132.58</p>



<p>Aug 23 01:08:38 swouter-x86 pppd[2149]: secondary DNS address 195.146.128.62</p>



<p>PPP 会话的唯一 ID 为 12411，对等方的目标地址为 00:90:1a:42:14:05。ppp0 接口的 IP 地址为 91.127.65.93，PPPoE 接入集中器的 IP 地址为 213.81.232.247。CHAP 身份验证成功。主 DNS 服务器和辅助 DNS 服务器的 IP 地址都将存储在 /var/run/ppp/resolv.conf 中。</p>



<p><strong>6. DNS 配置 &#8211; 更新 /etc/resolv.conf</strong></p>



<p>问题：</p>



<p>pppd 启动时文件 /etc/resolv.conf 未更新。可通过将复制命令添加到 /etc/ppp/ip-up.local 来解决此问题。该命令将名称服务器列表从 /var/run/ppp/resolv.conf 复制到 /etc/resolv.conf。脚本 ip-up.local 由 ip-up 脚本调用。</p>



<p>[root@swouter-x86 ~]#&nbsp;<code>echo "cp /var/run/ppp/resolv.conf /etc/resolv.conf" &gt; /etc/ppp/ip-up.local</code></p>



<p>[root@swouter-x86 ppp]#&nbsp;chmod 755 /etc/ppp/ip-up.local</p>



<p><strong>7. 创建初始化脚本以使 pppd 守护进程在启动时启动</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;vi /etc/init.d/pppd</p>



<p>#!/bin/sh</p>



<p><code>#</code></p>



<p><code># start/stop the pppd</code></p>



<p><code>#</code></p>



<p><code># chkconfig: 2345 11 86</code></p>



<p><code># description: pppd daemon</code></p>



<p><code># processname: pppd</code></p>



<p><code># config: /etc/ppp/peers/my_ISP</code></p>



<p><code># pidfile: /var/run/ppp0.pid</code></p>



<p><code>#</code></p>



<p><code>PATH=/bin:/usr/bin:/usr/local/bin:/sbin:/usr/sbin</code></p>



<p><code>export PATH</code></p>



<p># Source function library.</p>



<p><code>. /etc/rc.d/init.d/functions</code></p>



<p>stop()</p>



<p><code>{</code></p>



<p><code>echo -n "Stopping pppd daemon: "</code></p>



<p><code>killproc pppd</code></p>



<p><code>echo</code></p>



<p><code>rm -f /var/lock/subsys/pppd</code></p>



<p><code>}</code></p>



<p>start()</p>



<p><code>{</code></p>



<p><code>echo -n "Starting pppd daemon: "</code></p>



<p><code>daemon /usr/sbin/pppd call my_ISP</code></p>



<p><code>echo</code></p>



<p><code>touch /var/lock/subsys/</code></p>



<p><code>}</code></p>



<p># See how we were called.</p>



<p><code>case "$1" in</code></p>



<p><code>start)</code></p>



<p><code>start</code></p>



<p><code>;;</code></p>



<p><code>stop)</code></p>



<p><code>stop</code></p>



<p><code>;;</code></p>



<p><code>status)</code></p>



<p><code>status pppd</code></p>



<p><code>;;</code></p>



<p><code>restart)</code></p>



<p><code>stop</code></p>



<p><code>start</code></p>



<p><code>;;</code></p>



<p><code>*)</code></p>



<p><code>echo "Usage: pppd {start|stop|status|restart}"</code></p>



<p><code>exit 1</code></p>



<p><code>esac</code></p>



<p><code>&nbsp;exit 0</code></p>



<p>[root@swouter-x86 ~]#&nbsp;&nbsp;chmod 755 /etc/init.d/pppd</p>



<p>[root@swouter-x86 ~]#&nbsp;&nbsp;<code>chkconfig --add pppd</code>&nbsp;&nbsp;</p>



<p><strong>END.</strong></p>



<p>这是我在编写教程期间使用过的文章列表。</p>



<p>http://www.lampdocs.com/home-personal/pppoe-connection/</p>



<figure class="wp-block-embed"><div class="wp-block-embed__wrapper">
https://wiki.archlinux.org/index.php/PPPoE_Setup_with_pppd
</div></figure>



<p>http://www.brennan.id.au/05-Broadband_Connectivity.html</p>



<figure class="wp-block-embed"><div class="wp-block-embed__wrapper">
https://bugzilla.redhat.com/show_bug.cgi?id=517470
</div></figure>



<h1 class="wp-block-heading"><strong>第 6 部分 &#8211; 将盒子连接到互联网 &#8211; NAT 和防火墙配置</strong></h1>



<p>这是系列教程中的另一篇，介绍如何在 x86 硬件上构建 Linux 第 3 层交换机。在上一篇教程中，我们通过路由端口将交换机连接到 Internet。要将 LAN 用户连接到 Internet，我们必须在交换机上配置 NAT 和防火墙。</p>



<p>本文展示了防火墙和 NAT 配置。它没有解释 IP 数据包过滤或 IP 伪装如何工作，有关更多信息，请访问以下网站：</p>



<p>http://en.wikipedia.org/wiki/Firewall_%28computing%29</p>



<p>http://en.wikipedia.org/wiki/Network_address_translation</p>



<p><strong>1. 检查服务 itables 是否正在运行</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;etc/init.d/iptables status</p>



<p>iptables: Firewall is not running.</p>



<p>警告消息“iptables：防火墙未运行”告诉我们 iptables 服务未运行。我们必须使用以下命令启动 iptables 服务：</p>



<p>[root@swouter-x86 ~]#/etc/init.d/iptables start</p>



<p>iptables: Applying firewall rules: [&nbsp; OK&nbsp; ]</p>



<p>再次检查iptables状态：</p>



<p>[root@swouter-x86 ~]#/etc/init.d/iptables status</p>



<p>Table:&nbsp;nat</p>



<p>Chain PREROUTING (policy ACCEPT)</p>



<p>num&nbsp; target&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>Chain POSTROUTING (policy ACCEPT)</p>



<p>num&nbsp; target&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>Chain OUTPUT (policy ACCEPT)</p>



<p>num&nbsp; target&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>Table:&nbsp;filter</p>



<p>Chain INPUT (policy ACCEPT)</p>



<p>num&nbsp; target&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>1&nbsp;&nbsp;&nbsp; ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; &#8212;&nbsp; 0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; state RELATED,ESTABLISHED</p>



<p>2&nbsp;&nbsp;&nbsp; ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; icmp &#8212;&nbsp; 0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0.0.0/0</p>



<p>3&nbsp;&nbsp;&nbsp; ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; &#8212;&nbsp; 0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0.0.0/0</p>



<p>4&nbsp;&nbsp;&nbsp; ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; 0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; state NEW tcp dpt:22</p>



<p>5&nbsp;&nbsp;&nbsp; REJECT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; &#8212;&nbsp; 0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; reject-with icmp-host-prohibited</p>



<p>Chain FORWARD (policy ACCEPT)</p>



<p>num&nbsp; target&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>1&nbsp;&nbsp;&nbsp; REJECT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; &#8212;&nbsp; 0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0.0.0/0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; reject-with icmp-host-prohibited</p>



<p>Chain OUTPUT (policy ACCEPT)</p>



<p>num&nbsp; target&nbsp;&nbsp;&nbsp;&nbsp; prot opt source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>从上面的输出中我们可以看到加载了两个表 &#8211; NAT 和过滤表。我们需要它们 &#8211; NAT 表用于伪装，过滤表用于防火墙。</p>



<p>如果没有显示表，您可以使用命令轻松地将其加载到 Linux 内核。</p>



<p>[root@swouter-x86 ~]#modprobe iptable_filter</p>



<p>[root@swouter-x86 ~]#modprobe iptable_nat</p>



<p>第三个表是 Mangle 表，它未显示在输出中。此表用于服务质量 (QOS)，我们不会使用它。如果已加载它并且您不打算使用 QoS，请使用以下命令将其卸载：</p>



<p>[root@swouter-x86 ~]#rmmod iptable_mangle</p>



<p><strong>2.&nbsp;</strong><strong>刷新表过滤器和 nat 中的规则</strong><strong></strong></p>



<p>这是我们将要使用的选项列表。两个选项都是正确的，请使用其中一个来编写规则。</p>



<p><code>--flush</code>&nbsp;&nbsp;&nbsp; &nbsp;=&nbsp;-F</p>



<p><code>--table</code>&nbsp;&nbsp;&nbsp; &nbsp;=&nbsp;-t</p>



<p><code>--append</code>&nbsp; &nbsp;=&nbsp;-A</p>



<p><code>--out-interface</code>&nbsp;=&nbsp;-o</p>



<p><code>--in-interface</code>&nbsp; =&nbsp;-i</p>



<p><code>--jump</code>&nbsp; &nbsp; &nbsp; &nbsp; =&nbsp;-j</p>



<p><strong>a)&nbsp;Flush 过滤表</strong></p>



<p>如果您不指定具体的表，您的更改将始终在 Filter 表上进行，因为它被视为默认 iptable。例如：</p>



<p>[root@swouter-x86 ~]#<code>iptables --flush</code></p>



<p>含义相同：</p>



<p>[root@swouter-x86 ~]#<code>iptables -t filter --flush</code></p>



<p>但我们也可以使用更短的版本：</p>



<p>[root@swouter-x86 ~]#iptables&nbsp; -F</p>



<p><strong>b)&nbsp;Flush NAT 表</strong></p>



<p>[root@swouter-x86 ~]#iptables -t nat -F</p>



<p><strong>3. NAT 配置</strong></p>



<p>外部 NAT 接口是 ppp0。<br>内部 NAT 接口是 vlan1。</p>



<p>[root@swouter-x86 ~]#<code>iptables --table nat -A POSTROUTING -o ppp0 --jump MASQUERADE</code></p>



<p>保存 iptables:</p>



<p>[root@swouter-x86 ~]#/etc/init.d/iptables save</p>



<p>iptables: Saving firewall rules to /etc/sysconfig/iptables: [&nbsp; OK&nbsp; ]</p>



<p>详细检查NAT表配置：</p>



<p>[root@swouter-x86 ~]#iptables -t nat -L -v</p>



<p>Chain PREROUTING (policy ACCEPT 2 packets, 528 bytes)</p>



<p>pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</p>



<p>pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>0&nbsp;&nbsp;&nbsp;&nbsp; 0 MASQUERADE&nbsp; all&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; ppp0&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere</p>



<p>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</p>



<p>pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>通过外部接口 ppp0 传输来自任何内部接口且具有任何源 IP 地址的流量都将被转换。到目前为止，任何转换都已完成，因为 &#8211; pkts 计数器为空。</p>



<p><strong>4. 防火墙配置</strong></p>



<p><strong>a)&nbsp;检查默认过滤策略</strong></p>



<p>[root@swouter-x86 ~]#iptables -L -v</p>



<p>Chain INPUT (policy ACCEPT 140 packets, 14016 bytes)</p>



<p>pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>Chain FORWARD (policy ACCEPT 1726 packets, 145K bytes)</p>



<p>pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>Chain OUTPUT (policy ACCEPT 113 packets, 9052 bytes)</p>



<p>pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>所有链的默认配置策略均设置为 ACCEPT。假设 NAT 正常运行，您应该能够从 LAN ping 通 Internet。如果这样做，NAT 表中 POSTROUTING 策略的计数器 pkts 每次执行数据包中的源 IP 地址转换时都应该增加。</p>



<p><strong>b)&nbsp;更改默认过滤策略</strong></p>



<p>只要默认过滤策略设置为“接受”，则所有流量都会被允许，除非明确拒绝。Cisco IOS ACL 的工作方式不同 &#8211; 默认情况下，未明确允许的流量将被拒绝。这是更安全的方式，我们将实施它。此方法允许我们明确定义应允许通过防火墙的每种流量类型。</p>



<p>首先，我们需要将防火墙 iptable 中所有链的默认过滤策略更改为 DENY。</p>



<p><strong>注意：</strong>&nbsp; 在玩 iptable 过滤器时，建议通过串口连接到 box。如果出现问题，很容易断开连接。</p>



<p>[root@swouter-x86 ~]#iptables -P INPUT DROP</p>



<p>[root@swouter-x86 ~]#iptables -P OUTPUT DROP</p>



<p>[root@swouter-x86 ~]#iptables -P FORWARD DROP</p>



<p>你可能会注意到，现在无法从 LAN 中的主机 ping 通路由器的本地接口，因为 INPUT 链设置为 DROP。您无法从路由器 ping 通 Internet，因为 OUTPUT 链设置为 DROP。此外，由于 FORWARD 链的 DROP 策略，从 LAN 中的主机 ping 通 Internet 也不起作用。</p>



<p><strong>c)&nbsp;允许从 LAN 到路由器的 ssh 连接，反之亦然</strong></p>



<p>我们需要允许来自子网 172.18.0.0/16 且目标 TCP 端口为 22（ssh）的流量进入接口 vlan1。</p>



<p>[root@swouter-x86 ~]#iptab<code>les -A INPUT -i vlan1 -s 172.18.0.0/16 -p tcp --dport ssh -j ACCEPT</code></p>



<p>来自 LAN 到 VLAN1 接口的数据包，目标 TCP 端口为 22（ssh），可以到达 vlan1 接口，但无法建立 ssh 连接。OUPUT 链中的默认 DROP 策略阻止来自路由器本地接口的流量。我们需要添加命令以允许从 vlan1 接口到 LAN 上的主机的源 TCP 端口为 22 的连接。</p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -p tcp --sport 22 -o vlan1 -d 172.18.0.0/16 -j ACCEPT</code></p>



<p>现在 LAN 上的主机可以使用 ssh 连接到路由器。如果我们想允许从路由器的 vlan1 到 LAN 上的主机建立 ssh 连接，我们必须添加以下两个命令。</p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i vlan1 -s 172.18.0.0/16 -p tcp --sport ssh -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o vlan1 -d 172.18.0.0/16 -p tcp --dport ssh -j ACCEPT</code></p>



<p><strong>d)&nbsp;允许从 LAN 上的主机 ping 到默认网关，反之亦然</strong></p>



<p>Ping 是一种 ICMP 消息。以下规则允许来自子网 172.18.0.0/16 到 VLAN1 接口的 icmp 请求。</p>



<p>[root@swouter-x86 ~]#iptables -A INPUT -i vlan1 -s 172.18.0.0/16 -p icmp -j ACCEPT</p>



<p>我们还需要添加允许从 VLAN1 接口向 172.18.0.0/16 子网上的主机发送 ICMP 回显消息的规则。</p>



<p>[root@swouter-x86 ~]#iptables -A OUTPUT -o vlan1 -d 172.18.0.0/16 -p icmp -j ACCEPT</p>



<p><strong>e)&nbsp;允许来自路由器 ppp0 接口的 ping、DNS、http/https、ssh 访问互联网</strong></p>



<p>ICMP</p>



<p>[root@swouter-x86 ~]#iptables -A OUTPUT -o ppp0 -p icmp -j ACCEPT</p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i ppp0 -p icmp -m state --state ESTABLISHED -j ACCEPT</code></p>



<p>我们可以 ping 通 Internet 上的主机，但它们无法 ping 通 ppp0 接口。ppp0 接口上只允许建立 icmp 连接。</p>



<p>ICMP localhost</p>



<p>[root@swouter-x86 /]#iptables -A OUTPUT -o lo -p icmp -j ACCEPT</p>



<p>[root@swouter-x86 /]#iptables -A INPUT -i lo -p icmp -j ACCEPT</p>



<p>此规则允许 ping 环回接口本身以及从路由器 ping 本地接口。</p>



<p>DNS 客户端</p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o ppp0 -p udp --dport 53 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i ppp0 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT</code></p>



<p>该规则允许将 DNS 查询发送到提供商的 DNS 服务器。</p>



<p>本地 DNS 服务器 &#8211; 从 LAN 访问</p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i vlan1 -p udp --dport 53 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o vlan1 -p udp --sport 53 -j ACCEPT</code></p>



<p>该规则允许来自 LAN 的 DNS 请求到达路由器上运行的本地 DNS 服务器。</p>



<p>DNS 服务器 &#8211; 路由器自身对本地 DNS 服务器的查询</p>



<p>[root@swouter-x86 /]#iptables -A INPUT -i lo -p udp -j ACCEPT</p>



<p>[root@swouter-x86 /]#iptables -A OUTPUT -o lo -p udp -j ACCEPT</p>



<p>将允许从路由器发起到本地 DNS 服务器的 DNS 查询。</p>



<p>HTTP/HTTPS</p>



<p>我们需要允许源自路由器的 http 流量来接收 CentOS 更新。</p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o ppp0 -p tcp --dport 80 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUT PUT -o ppp0 -p tcp --dport 443 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i ppp0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i ppp0 -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT</code></p>



<p>SSH to the Internet</p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o ppp0 -p tcp --dport 22 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i ppp0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT</code></p>



<p><strong>f)&nbsp;NTP 客户端和服务器规则</strong></p>



<p>允许在路由器上运行的 NTP 客户端与公共 NTP 服务器同步。</p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o ppp0 -p udp --dport 123 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i ppp0 -p udp --sport 123 -j ACCEPT</code></p>



<p>允许NTP服务器为LAN上的主机提供服务。</p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i vlan1 -p udp --dport 123 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o vlan1 -p udp --sport 123 -j ACCEPT</code></p>



<p><strong>g)&nbsp;允许来自 LAN 的 DHCP 请求到达 DHCP 服务器，反之亦然</strong></p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i vlan1 -p udp --dport 67 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i vlan1 -p udp --dport 68 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o vlan1 -p udp --sport 67 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o vlan1 -p udp --sport 68 -j ACCEPT</code></p>



<p><strong>h)&nbsp;允许局域网上的主机访问 Samba 服务器</strong></p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i vlan1 -p tcp -m multiport --dport 137,138,139,445 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i vlan1 -p udp -m multiport --dport 137,138,139,445 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o vlan1 -p tcp -m multiport --sport 137,138,139,445 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o vlan1 -p udp -m multiport --sport 137,138,139,445 -j ACCEPT</code></p>



<p><strong>i)&nbsp;仅允许来自互联网的已建立会话转发到 LAN</strong></p>



<p>[root@swouter-x86 ~]#/<code>sbin/iptables -A FORWARD -i ppp0 -o vlan1 -m state --state RELATED,ESTABLISHED -j ACCEPT</code></p>



<p><strong>j)&nbsp;</strong><strong>允许将源自 LAN 的任何流量转发到 Internet</strong><strong></strong></p>



<p>[root@swouter-x86 ~]#/sbin/iptables -A FORWARD -i vlan1 -o ppp0 -j ACCEPT</p>



<p><strong>k)&nbsp;检查过滤表</strong></p>



<p>[root@swouter-x86 ~]#iptables -L -v</p>



<p>Chain&nbsp;INPUT(policy&nbsp;DROP56 packets, 7156 bytes)</p>



<p>pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; icmp &#8212;&nbsp; vlan1&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; 172.18.0.0/16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere</p>



<p>145 12353ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; vlan1&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; 172.18.0.0/16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp dpt:ssh</p>



<p>0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; vlan1&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; 172.18.0.0/16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp spt:ssh</p>



<p>0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; icmp &#8212;&nbsp; ppp0&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; state ESTABLISHED</p>



<p>401 54442ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; ppp0&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; udp spt:domain state ESTABLISHED</p>



<p>8&nbsp;&nbsp; 948 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; ppp0&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp spt:http state ESTABLISHED</p>



<p>7&nbsp; 1837 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; ppp0&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp spt:https state ESTABLISHED</p>



<p>0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; ppp0&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp spt:ssh state ESTABLISHED</p>



<p>20&nbsp; 1552 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; icmp &#8212;&nbsp; lo&nbsp;&nbsp;&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere</p>



<p>11&nbsp;&nbsp; 836 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; vlan1&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; udp dpt:ntp</p>



<p>37&nbsp; 2812 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; ppp0&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; udp spt:ntp</p>



<p>304 19672ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; vlan1&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; udp dpt:domain</p>



<p>20&nbsp; 1559 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; lo&nbsp;&nbsp;&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere</p>



<p>4&nbsp;&nbsp; 200 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; lo&nbsp;&nbsp;&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere</p>



<p>1&nbsp;&nbsp; 328 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; vlan1&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; udp dpt:bootps</p>



<p>0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; vlan1&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; udp dpt:bootpc</p>



<p>65 11009ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; vlan1&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; multiport dports netbios-ns,netbios-dgm,netbios-ssn,microsoft-ds</p>



<p>139 13812&nbsp;ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; vlan1&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; multiport dports netbios-ns,netbios-dgm,netbios-ssn,microsoft-ds</p>



<p>Chain&nbsp;FORWARD&nbsp;(policy&nbsp;DROP&nbsp;0 packets, 0 bytes)</p>



<p>pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>1800 1232K ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; &#8212;&nbsp; ppp0&nbsp;&nbsp; vlan1&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; state RELATED,ESTABLISHED</p>



<p>2481&nbsp; 305K ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; &#8212;&nbsp; vlan1&nbsp; ppp0&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere</p>



<p>Chain&nbsp;OUTPUT(policyDROP0 packets, 0 bytes)</p>



<p>pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination</p>



<p>90 10749ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; vlan1&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 172.18.0.0/16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp spt:ssh</p>



<p>0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; icmp &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; vlan1&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 172.18.0.0/16</p>



<p>0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; vlan1&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 172.18.0.0/16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp dpt:ssh</p>



<p>16&nbsp; 1488 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; icmp &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; ppp0&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere</p>



<p>401 27246ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; ppp0&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; udp dpt:domain</p>



<p>10&nbsp;&nbsp; 718 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; ppp0&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp dpt:http</p>



<p>8&nbsp;&nbsp; 933 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; ppp0&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp dpt:https</p>



<p>0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; ppp0&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tcp dpt:ssh</p>



<p>20&nbsp; 1552 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; icmp &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; lo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere</p>



<p>11&nbsp;&nbsp; 836 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; vlan1&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; udp spt:ntp</p>



<p>37&nbsp; 2812 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; ppp0&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; udp dpt:ntp</p>



<p>304 39665ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; vlan1&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; udp spt:domain</p>



<p>20&nbsp; 1559 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; lo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere</p>



<p>4&nbsp;&nbsp; 200 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; lo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere</p>



<p>0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; vlan1&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; udp spt:bootpc</p>



<p>0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; vlan1&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; udp spt:bootps</p>



<p>74&nbsp; 9590 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; vlan1&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; multiport sports netbios-ns,netbios-dgm,netbios-ssn,microsoft-ds</p>



<p>0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; &#8212;&nbsp; any&nbsp;&nbsp;&nbsp; vlan1&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; multiport sports netbios-ns,netbios-dgm,netbios-ssn,microsoft-ds</p>



<p><strong>5. 允许接口之间的转发</strong></p>



<p>[root@swouter-x86]#sysctl -w net.ipv4.ip_forward=1</p>



<p>[root@swouter-x86]#sysctl -w net.ipv6.conf.all.forwarding=1</p>



<p>要在启动时启用转发，请编辑 /etc/sysctl.conf 并更改/添加以下行。</p>



<p>net.ipv4.ip_forward = 1</p>



<p>net.ipv6.conf.default.forwarding=1</p>



<p><strong>6.&nbsp; 保存并重启iptables</strong></p>



<p>[root@swouter-x86 ~]#/etc/init.d/iptables save</p>



<p>iptables: Saving firewall rules to /etc/sysconfig/iptables: [&nbsp; OK&nbsp; ]</p>



<p>[root@swouter-x86 ~]#&nbsp;/etc/init.d/iptables restart</p>



<p>iptables: Flushing firewall rules: [&nbsp; OK&nbsp; ]</p>



<p>iptables: Setting chains to policy ACCEPT: filter nat [&nbsp; OK&nbsp; ]</p>



<p>iptables: Unloading modules: [&nbsp; OK&nbsp; ]</p>



<p>iptables: Applying firewall rules: [&nbsp; OK&nbsp; ]</p>



<p>使 iptables 在启动后启动。</p>



<p>[root@swouter-x86 ~]#&nbsp;chkconfig iptables on</p>



<p><strong>END.</strong></p>



<p>以下是我在写作过程中大量使用的文章列表。</p>



<p>http://www.yolinux.com/TUTORIALS/LinuxTutorialIptablesNetworkGateway.html</p>



<p>http://www.bctes.com/nat-linux-iptables.html</p>



<p>http://billauer.co.il/ipmasq-html.html</p>



<figure class="wp-block-embed"><div class="wp-block-embed__wrapper">
https://help.ubuntu.com/community/IptablesHowTo
</div></figure>



<p>http://www.gentoo.org/doc/en/home-router-howto.xml</p>



<p>http://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers</p>



<h1 class="wp-block-heading"><strong>第 7 部分 &#8211; DDNS 和 NTP 安装和配置</strong></h1>



<p>在之前的教程中，我们在 Linux 第 3 层交换机上配置了防火墙和 NAT，以允许 LAN 用户连接到 Internet。我们将继续构建 Linux L3 交换机，并在交换机上配置 NTP 和动态 DNS 服务。交换机将通过 Internet 与公共 NTP 服务器同步其时间，并为 LAN 上的设备提供准确的时间。借助动态 DNS 服务，即使动态分配了公共 IP 地址，也可以通过其域名访问它。此 IP 地址是通过交换机路由接口上的 ISP DHCP 服务器通过 DHCP 分配的。</p>



<p>解释构建 LInux L3 交换机概念的入门教程在这里。</p>



<h3 class="wp-block-heading"><strong>网络时间协议 NTP &#8211; 客户端和服务器配置</strong></h3>



<p>假设我们熟悉网络时间协议的工作原理，我们将在交换机上安装和配置 NTP，如下所示。</p>



<p><strong>1. 安装 NTP 工具</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;yum install ntp</p>



<p><strong>2. NTP 客户端配置</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;vi /etc/ntp.conf</p>



<p><strong>a)&nbsp;指定 NTP 公共服务器或保留默认值</strong></p>



<p>这些是默认的预配置公共 NTP 服务器。</p>



<p>server 0.rhel.pool.ntp.org</p>



<p>server 1.rhel.pool.ntp.org</p>



<p>server 2.rhel.pool.ntp.org</p>



<p><strong>b)&nbsp;限制公共 NTP 服务器对我们的 NTP 服务器的访问</strong></p>



<p>restrict default kod nomodify notrap nopeer noquery</p>



<p>restrict -6 default kod nomodify notrap nopeer noquery</p>



<p>时间将与公共 NTP 服务器同步，但服务器不允许修改运行时配置或查询我们的 Linux NTP 服务器。</p>



<p><strong>c)&nbsp;</strong><strong>启动 ntpd 守护进程，并使 ntpd 守护进程在启动时启动</strong></p>



<p>root@swouter-x86 ~]#&nbsp;/etc/init.d/ntpd start</p>



<p>[root@swouter-x86 ~]#&nbsp;chkconfig ntpd on</p>



<p><strong>d)&nbsp;检查同步是否有效</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;ntpq -p</p>



<p>ntpq: read: Connection refused</p>



<p>检查 /var/log/messages 中是否有任何错误消息。</p>



<p>[root@swouter-x86 ~]#&nbsp;tail /var/log/messages</p>



<p>Sep&nbsp; 4 14:23:34 swouter-x86 ntpd[1735]: kernel time sync status 2040</p>



<p>Sep&nbsp; 4 14:23:35 swouter-x86 ntpd[1735]: sendto(81.89.63.67) (fd=24): Operation not permitted</p>



<p>Sep&nbsp; 4 14:23:36 swouter-x86 ntpd[1735]: sendto(217.73.16.2) (fd=24): Operation not permitted</p>



<p>Sep&nbsp; 4 14:24:39 swouter-x86 ntpd[1735]: sendto(81.89.63.67) (fd=24): Operation not permitted</p>



<p>Sep&nbsp; 4 14:24:42 swouter-x86 ntpd[1735]: sendto(217.73.16.2) (fd=24): Operation not permitted</p>



<p>Sep&nbsp; 4 14:25:44 swouter-x86 ntpd[1735]: sendto(81.89.63.67) (fd=24): Operation not permitted</p>



<p>Sep&nbsp; 4 14:25:45 swouter-x86 ntpd[1735]: sendto(217.73.16.2) (fd=24): Operation not permitted</p>



<p>Sep&nbsp; 4 14:26:49 swouter-x86 ntpd[1735]: sendto(81.89.63.67) (fd=24): Operation not permitted</p>



<p>Sep&nbsp; 4 14:26:50 swouter-x86 ntpd[1735]: sendto(217.73.16.2) (fd=24): Operation not permitted</p>



<p>Sep&nbsp; 4 14:27:00 swouter-x86 ntpd[1735]: ntpd exiting on signal 15</p>



<p>显然，防火墙配置拒绝来自路由器的目标 UDP 端口 123 的 NTP 流量到达互联网上的公共 NTP 服务器。</p>



<p>[root@swouter-x86 ~]#&nbsp;<code>iptables -A OUTPUT -o ppp0 -p udp --dport 123 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]# i<code>iptables -A INPUT -i ppp0 -p udp --sport 123&nbsp; -j ACCEPT</code></p>



<p>重新启动 ntpd 守护程序。</p>



<p>[root@swouter-x86 ~]#&nbsp;/etc/init.d/ntpd restart</p>



<p>Shutting down ntpd: [FAILED]</p>



<p>Starting ntpd: [OK]</p>



<p>[root@swouter-x86 ~]#&nbsp;ntpq -p</p>



<p>remote&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; refid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; st t when poll reach&nbsp;&nbsp; delay&nbsp;&nbsp; offset&nbsp; jitter</p>



<p>=====================================================</p>



<p>ns2.vnet.sk&nbsp;&nbsp;&nbsp;&nbsp; 81.89.63.150&nbsp;&nbsp;&nbsp;&nbsp; 2 u&nbsp; 100&nbsp;&nbsp; 64&nbsp;&nbsp;&nbsp; 2&nbsp;&nbsp;&nbsp; 5.308&nbsp; -63.725&nbsp;&nbsp; 0.008</p>



<p>*lb02.vnet.sk&nbsp;&nbsp;&nbsp; 194.160.23.2&nbsp;&nbsp;&nbsp;&nbsp; 2 u&nbsp;&nbsp; 32&nbsp;&nbsp; 64&nbsp;&nbsp; 77&nbsp;&nbsp;&nbsp; 5.185&nbsp; -67.698&nbsp; 39.818</p>



<p>为了正确同步，延迟和偏移值必须非零，并且抖动值应低于 100。同步成功后，特定 NTP 服务器旁边必须显示符号 *。</p>



<p>[root@swouter-x86 ~]#&nbsp;date</p>



<p>Sun Sep&nbsp; 4 12:56:32 CEST 2011</p>



<p>时间已正确更新，因此我们可以开始配置 NTP 服务器。</p>



<p><strong>3. NTP 服务器配置</strong></p>



<p><strong>a)&nbsp;</strong><strong>配置 NTP 服务器以仅响应来自 LAN 的 NTP 查询</strong><strong></strong></p>



<p>时间将与公共 NTP 服务器同步，但这些服务器不允许修改运行时配置或查询我们的 Linux NTP 服务器。编辑文件 /etc/ntpd.conf 并添加以下几行。</p>



<p>restrict default kod nomodify notrap nopeer noquery</p>



<p>restrict -6 default kod nomodify notrap nopeer noquery</p>



<p>拒绝从互联网查询我们的 NTP 服务器，并拒绝修改我们的 NTP 服务器的运行时配置。</p>



<p>restrict 0.rhel.pool.ntp.org&nbsp; mask 255.255.255.255 nomodify notrap noquery</p>



<p>restrict 1.rhel.pool.ntp.org mask 255.255.255.255 nomodify notrap noquery</p>



<p>restrict 2.rhel.pool.ntp.org mask 255.255.255.255 nomodify notrap noquery</p>



<p>要允许 LAN 上的主机查询我们的 NTP 服务器，您需要添加此规则。</p>



<p>restrict 172.18.0.0 mask 255.255.0.0 nomodify notrap</p>



<p><strong>b)&nbsp;重新启动在 NTP 服务器上运行的 ntpd 守护程序</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;/etc/init.d/ntpd restart</p>



<p><strong>c)&nbsp;配置 iptables 以允许来自 LAN 上的主机的 NTP 查询</strong></p>



<p>我们将允许交换机虚拟接口 SVI &#8211; vlan1 上具有源和目标 UDP 端口 123 的入站和出站流量。</p>



<p>[root@swouter-x86 ~]#&nbsp;<code>iptables -A INPUT -i vlan1 -p udp --dport 123 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#&nbsp;<code>iptables -A OUTPUT -o vlan1 -p udp --sport 123 -j ACCEPT</code></p>



<p><strong>3. 在局域网内电脑上配置NTP</strong></p>



<p>步骤与路由器上 NTP 客户端的配置非常相似。注释指向公共 NTP 服务器的行，并将我们的 NTP 服务器 IP 地址 172.18.100.150 放入 /etc/ntp.conf。重新启动 ntpd 守护进程并等待同步。请记住，我们的 NTP 服务器必须先与公共 NTP 服务器同步。之后，您的计算机可能会与我们的 NTP 服务器同步时间。</p>



<p><strong>4. 故障排除</strong>重启 Linux 路由器后，NTP 对等点不可用。这可能是由于公共 NTP 服务器不可用或防火墙配置不当导致无法访问服务器。</p>



<p>[root@swouter-x86 ~]#&nbsp;ntpq -d -p</p>



<p>No association ID&#8217;s returned</p>



<p>重新启动 npdd 守护进程后，对等点立即显示在 ntpqd 的输出中，并且发生同步。</p>



<p><strong>解释：</strong></p>



<p>在 Linux NTP 服务器启动期间，无法通过其域名访问公共 NTP 服务器，因为在 NTP 守护进程启动之前，pppd 守护进程未将公共 DNS 服务器添加到 /etc/resolv.conf。因此，在 /etc/ntpd.conf 中，应通过其 IP 地址而不是域名来定义公共 NTP 服务器。本文更详细地描述了这个问题。</p>



<h3 class="wp-block-heading"><strong>动态 DNS /DDNS/ 配置</strong></h3>



<p>动态 DNS 是一种服务，允许我们在公共 IP 地址从 ISP DHCP 服务器动态分配的情况下使用域名。为了实现它，我们的 Linux L3 交换机必须定期向 DDNS 提供商发送 http 格式的查询。借助这些查询，DDSN 提供商会获知交换机的公共 IP 地址并存储该对 &#8211; IP 地址和特定 DNS 名称。它允许使用交换机的公共 IP 地址来回答 DNS 查询。</p>



<p><strong>注意:&nbsp;</strong>我选择了 DynDNS 来提供 DDNS 服务，但您可以随意使用您喜欢的任何 DDNS 提供商。请注意，本教程是使用 DynNDS 服务提供商编写的 DDNS 配置。</p>



<p><strong>1. 注册你的 DynDNS 域名</strong></p>



<ul class="wp-block-list">
<li>导航到 http://dyn.com/dns/dyndns-free/</li>



<li>点击“立即获取“</li>



<li>填写主机名、IPv4或IPv6地址，点击下一步</li>



<li>注册您的账户 &#8211; 登录名/密码、电子邮件等。点击“创建账户</li>



<li>确认邮件将发送到您的电子邮件帐户。单击电子邮件中提供的链接以激活 DynDNS 帐户</li>



<li>点击“激活您的免费 DynDNS”</li>
</ul>



<p><strong>2. 安装必要的软件包</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;yum install perl-IO-Socket-SSL perl-Net-LibIDN</p>



<p><strong>3. 安装最新的 DDNS 客户端</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;wget http://sourceforge.net/projects/ddclient/files/ddclient/ddclient-3.8.1/ddclient-3.8.1.tar.gz/download</p>



<p>[root@swouter-x86 ~]#&nbsp;tar zxvf ddclient-3.8.1.tar.gz</p>



<p>[root@swouter-x86 ~]#&nbsp;cd ./ddclient-3.8.1</p>



<p>[root@swouter-x86 ddclient-3.8.1]#&nbsp;mkdir /etc/ddclient/</p>



<p>[root@swouter-x86 ddclient-3.8.1]#&nbsp;mkdir /var/cache/ddclient/</p>



<p>[root@swouter-x86 ddclient-3.8.1]#&nbsp;cp ddclient /usr/local/sbin</p>



<p>[root@swouter-x86 ddclient-3.8.1]#&nbsp;cp sample-etc_ddclient.conf /etc/ddclient/ddclient.conf</p>



<p>[root@swouter-x86 ddclient-3.8.1]#&nbsp;cp sample-etc_rc.d_init.d_ddclient /etc/rc.d/init.d/ddclient</p>



<p>[root@swouter-x86 ddclient-3.8.1]#&nbsp;<code>chkconfig --add ddclient</code></p>



<p><strong>4. 配置 /etc/ddclient/dddclient.conf</strong></p>



<p>编辑文件 /etc/ddclient/ddclient 并添加以下行。</p>



<p>daeomon=300</p>



<p>use=web</p>



<p>login=brezular</p>



<p>password=yourdyndnspassword</p>



<p>server=members.dyndns.org</p>



<p>protocol=dyndns2</p>



<p>brezular.dyndns.org</p>



<p>现在启动 ddclient 守护进程：</p>



<p>[root@swouter-x86 ddclient-3.8.1]#&nbsp;/etc/init.d/ddclient start</p>



<p>Starting ddclient: WARNING:&nbsp; file /etc/ddclient/ddclient.conf: file /etc/ddclient/ddclient.conf must be accessible only by its owner (fixed).</p>



<p>[&nbsp; OK&nbsp; ]</p>



<p>其他用户的权限被踢出，并保留所有者（root）的读写权限。</p>



<p>[root@swouter-x86 ddclient-3.8.1]#&nbsp;ls -l /etc/ddclient/ddclient.conf</p>



<p>-rw&#8212;&#8212;-. 1 root root 5919 Sep&nbsp; 3 21:12 /etc/ddclient/ddclient.conf</p>



<p>检查 ddclient 是否正在运行</p>



<p>[root@swouter-x86 ddclient-3.8.1]#&nbsp;/etc/init.d/ddclient status</p>



<p>ddclient (pid&nbsp; 2011) is running&#8230;</p>



<p><strong>5. 配置 DynDNS 提供商的 IP 地址更新</strong></p>



<p>[root@swouter-x86 ddclient-3.8.1]#&nbsp;ps -aux | grep ddclient</p>



<p>root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2011&nbsp; 0.0&nbsp; 0.8&nbsp; 15124&nbsp; 8260 pts/0&nbsp;&nbsp;&nbsp; S&nbsp;&nbsp;&nbsp; 21:30&nbsp;&nbsp; 0:00 ddclient &#8211; sleeping for 300 seconds</p>



<p>Ddclient 以守护进程模式运行。/etc/ddclient/ddclient.conf 中的参数 daemon=300 表示每 300 秒激活一次 ddclient 并检查公共 IP 地址是否发生变化。如果 IP 地址发生变化，则会自动向 ddns 服务器发送更新。如果没有变化，则不会发送更新。</p>



<p>但是，以守护进程模式运行的 ddclient 应该每月自动发送一次更新，即使 ip 地址没有任何变化，以保持帐户处于活跃状态。</p>



<p><strong>6. 测试 DynDNS</strong></p>



<p>[root@swouter-x86 /]#&nbsp;ping brezular.dyndns.org</p>



<p>PING brezular.dyndns.org (78.98.103.30) 56(84) bytes of data.</p>



<p>64 bytes from adsl-dyn30.78-98-103.t-com.sk (78.98.103.30): icmp_seq=1 ttl=64 time=0.145 ms</p>



<p>64 bytes from adsl-dyn30.78-98-103.t-com.sk (78.98.103.30): icmp_seq=2 ttl=64 time=0.091 ms</p>



<p>64 bytes from adsl-dyn30.78-98-103.t-com.sk (78.98.103.30): icmp_seq=3 ttl=64 time=0.109 ms</p>



<p>64 bytes from adsl-dyn30.78-98-103.t-com.sk (78.98.103.30): icmp_seq=4 ttl=64 time=0.118 ms</p>



<p><strong>END.</strong></p>



<p>在编写本教程的过程中大量使用了以下文章。</p>



<p>NTP</p>



<p>http://www.linuxhomenetworking.com/wiki/index.php/Quick_HOWTO_:_Ch24_:_The_NTP_Server</p>



<p>http://www.brennan.id.au/09-Network_Time_Protocol.html</p>



<p>http://www.ghidinelli.com/2008/09/25/iptables-firewall-rules-for-ntpd-time-synchronization</p>



<p>DynDNS</p>



<p>http://en.wikipedia.org/wiki/Dynamic_DNS</p>



<p>http://www.linuxhomenetworking.com/wiki/index.php/Quick_HOWTO_:_Ch19_:_Dynamic_DNS</p>



<p>http://www.sonoracomm.com/support/19-inet-support/232-ddclient</p>



<p>http://sourceforge.net/apps/trac/ddclient</p>



<p>http://www.ubuntugeek.com/update-ip-addresses-at-dynamic-dns-services-using-ddclient.html</p>



<h1 class="wp-block-heading"><strong>第 8 部分 &#8211; DNS 缓存服务器安装和配置</strong></h1>



<p>到目前为止，我们已经在 x86 硬件上安装了 CentOS，安装了 Open vSwitch，并将无线和有线 LAN 用户连接到我们的 Linux 第 3 层交换机。然后，我们将交换机连接到 Internet，启用 NAT 和数据包过滤。我们将交换机配置为与公共 NTP 服务器同步其时间，并为 LAN 上的主机提供时间。交换机还配置为在其公共 IP 地址发生变化时向公共动态 DNS 服务器发送更新。</p>



<p>Linux三层交换机概念介绍到此。</p>



<p>我们将继续构建具有 DNS 缓存服务器配置的 Linux L3 交换机。DNS 缓存服务器将经常访问的网站的 IP 地址缓存到 RAM 内存中。IP 地址是从本地 DNS 缓存服务器检索的，因此无需联系公共 DNS 服务器。拥有自己的缓存 DNS 服务器有两个主要好处：</p>



<p>&nbsp;&nbsp;&nbsp;&nbsp; 提高 DNS 查找速度</p>



<p>&nbsp;&nbsp;&nbsp;&nbsp; 减少 ISP 链路上的总流量</p>



<p><strong>1. 安装绑定缓存 DNS 服务器</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;yum install bind bind-utils</p>



<p><strong>2. 配置绑定缓存 DNS 服务器</strong></p>



<p>我们将配置 /etc/named.conf 以使 DNS 缓存服务器正常工作。此文件的更改以绿色显示。我们必须指定 DNS 服务器监听的 IP 地址和端口。还需要指定请求 DNS 查找的源 IP 地址范围。最后一步是配置必须在转发器列表中指定的公共 DNS 服务器。</p>



<p>[root@swouter-x86 ~]#&nbsp;vi /etc/named.conf</p>



<p>//listen-on port 53 { 127.0.0.1; };</p>



<p>listen-on port 53 { 127.0.0.1; 172.18.100.150; };</p>



<p>//allow-query&nbsp;&nbsp;&nbsp;&nbsp; { localhost; };</p>



<p>allow-query&nbsp;&nbsp;&nbsp;&nbsp; { localhost; 172.18.0.0/16; };</p>



<p>//dnssec-enable yes;</p>



<p>dnssec-enable no;</p>



<p>//dnssec-validation yes;</p>



<p>dnssec-validation no;</p>



<p>//Add list of forwarders &#8211; public DNS of ISP</p>



<p>forwarders { 195.146.132.58; 195.146.128.62; };</p>



<p><strong>3. 指定缓存 DNS 服务器</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;/etc/resolv.conf</p>



<p>nameserver 127.0.0.1</p>



<p><strong>4. 指定缓存 DNS 服务器</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;/etc/init.d/named start</p>



<p>[root@swouter-x86 ~]#&nbsp;chkconfig named on</p>



<p><strong>5. Iptables 配置</strong></p>



<p>允许路由器本身发送 DNS 请求并接收回复：</p>



<p>[root@swouter-x86 ~]#&nbsp;<code>iptables -A OUTPUT -o ppp0 -p udp --dport 53 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#&nbsp;<code>iptables -A INPUT -i ppp0 -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT</code></p>



<p>允许来自 LAN 上的主机的 DNS 请求到达缓存 DNS 服务器。</p>



<p>[root@swouter-x86 ~]#<code>&nbsp;iptables -A INPUT -i vlan1 -p udp --dport 53 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#&nbsp;<code>iptables -A OUTPUT -o vlan1 -p udp --sport 53 -j ACCEPT</code></p>



<p>允许路由器本身生成的 DNS 查询发送到公共 DNS 服务器。</p>



<p>[root@swouter-x86 /]#&nbsp;iptables -A INPUT -i lo -p udp -j ACCEPT</p>



<p>[root@swouter-x86 /]#&nbsp;iptables -A OUTPUT -o lo -p udp -j ACCEPT</p>



<p>允许 rndc 监听 TCP 953</p>



<p>[root@swouter-x86 /]#&nbsp;iptables -A INPUT -i lo -p tcp -j ACCEPT</p>



<p>[root@swouter-x86 /]#&nbsp;iptables -A OUTPUT -o lo -p tcp -j ACCEPT</p>



<p><strong>6. 避免重写 /etc/resolv.conf</strong></p>



<p>在 PPPoE 教程配置中，我们必须将行 echo &#8220;cp /var/run/ppp/resolv.conf /etc/resolv.conf&#8221; &gt; /etc/ppp/ip-up.local 添加到文件 /etc/ppp/ip-up.local。此行将文件 /var/run/ppp/resolv.conf 的内容复制到 /etc/resolv.conf，以便使用公共 DNS 服务器列表更新 /etc/resolv.conf。</p>



<p>现在我们必须从文件 /etc/ppp/ip-up.local 中删除此行，以便条目“nameserver 127.0.0.1”不会在 /etc/resolv.conf 中被重写。</p>



<p><strong>7. 更改启动时启动命名守护进程的优先级</strong></p>



<p>为了让缓存 DNS 服务器正常工作，我们必须按顺序将命名服务器守护进程作为最后一个守护进程启动。优先级越高意味着守护进程越晚启动。编辑文件 /etc/init.d/named，将以 chkconfig 开头的行的 S 参数从 13 更改为 99。</p>



<p><strong>a)&nbsp;从 chkconfig 管理中删除命名守护进程</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;<code>chkconfig --del named</code></p>



<p><strong>b)&nbsp;编辑 /etc/init.d/named 并找到以 #chkconfig 开头的行：- 13 87</strong></p>



<p>将数字 13 改为 99，这样将使 named 守护进程作为 CentOS 启动过程中的最后一个守护进程启动。</p>



<p><strong>c)&nbsp;在 chkconfig 命令的管理下添加命名守护进程，并在所有运行级别启动它</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;<code>chkconfig --add named</code></p>



<p>[root@swouter-x86 ~]#&nbsp;chkconfig named on</p>



<p><strong>End.</strong></p>



<p>在编写本教程的过程中大量使用了以下文章。</p>



<p>http://www.lamolabs.org/blog/282/how-to-setup-a-dns-server-on-centos-5/</p>



<p>http://www.linuxhomenetworking.com/wiki/index.php/Quick_HOWTO_:_Ch18_:_Configuring_DNS</p>



<p>http://www.labtestproject.com/linnet/dns-server.html</p>



<p>http://www.zaphu.com/2007/09/10/ubuntu-dns-server-guide-bind-caching-name-server-setup/</p>



<p>http://www.zaphu.com/2007/09/14/ubuntu-dns-server-guide-bind-master-server-setup/</p>



<p>http://h30499.www3.hp.com/t5/System-Administration/iptables-is-blocking-rndc/td-p/3034191</p>



<h1 class="wp-block-heading"><strong>第 9 部分 &#8211; DHCP 和 Samba 服务器的安装和配置</strong></h1>



<p>这是在 x86 硬件上构建 Linux 第 3 层交换机的系列教程的最后一篇。本教程介绍了如何在 CentOS 上安装和配置 DHCP 服务器，以便为 LAN 上的主机提供 IP 地址。由于交换机有足够的可用硬盘空间，我们将安装和配置 Samba 服务器，以便 Windows 用户访问他们的主目录</p>



<h3 class="wp-block-heading"><strong>DHCP 服务器安装和配置</strong></h3>



<p><strong>1. 安装必要的软件包</strong></p>



<p>[root@swouter-x86 ~]#<strong>&nbsp;&nbsp;</strong>yum install dhcp</p>



<p><strong>2. 配置 DHCP 服务器</strong></p>



<p>将以下行添加到 /etc/dhcp/dhcpd.conf。</p>



<p>[root@swouter-x86 ~]#&nbsp;&nbsp;vi /etc/dhcp/dhcpd.conf</p>



<p>#DNS update schemes</p>



<p>ddns-update-style none;</p>



<p>#Ignore clients updates</p>



<p>ignore client-updates;</p>



<p>#Define interface on which is DHCP daemon listenning</p>



<p>DHCPARGS=vlan1;</p>



<p>subnet 172.18.0.0 netmask 255.255.0.0 {</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp;option routers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 172.18.100.150;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# gateway on vlan1 internal interface</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp;option subnet-mask&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 255.255.0.0;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;# subnet mask</p>



<p>option domain-name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#8220;brezular.dyndns.org&#8221;; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;# domain name given to client</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp;option domain-name-servers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 172.18.100.150;&nbsp; &nbsp;&nbsp;# the IP of our DNS server</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp;option time-offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -18000;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;# Eastern Standard Time &#8211; set to what you have</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp;option ntp-servers&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;172.18.100.150;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the IP of our NTP server</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp;range &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.18.0.1 172.18.99.255;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;# the first range of IP&#8217;s our clients will get</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp;range &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; 172.18.101.0 172.18.255.254;&nbsp;&nbsp;# the second range of of IP&#8217;s our clients will get</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp;default-lease-time 43200;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# how long the client&#8217;s will keep the same IP</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp;max-lease-time 86400;</p>



<p>host DNS_server &nbsp; &nbsp; &nbsp;&nbsp;#reserved IP address</p>



<p>&nbsp; &nbsp; &nbsp; {</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp; hardware ethernet 00:23:20:8D:B6:4C;</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp; fixed-address 172.18.100.150;</p>



<p>&nbsp; &nbsp; &nbsp; }</p>



<p>host Linux_box&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#reserved IP address for host on LAN</p>



<p>&nbsp; &nbsp; &nbsp; {</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp; hardware ethernet 00:13:E8:C1:FB:13;</p>



<p>&nbsp; &nbsp; &nbsp; &nbsp; fixed-address 172.18.100.141;</p>



<p>&nbsp; &nbsp; &nbsp; }</p>



<p>}</p>



<p><strong>4. 测试配置并启动 dhcpd 守护进程</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;&nbsp;service dhcpd configtest</p>



<p>Syntax: OK</p>



<p>[root@swouter-x86 ~]#&nbsp;&nbsp;/etc/init.d/dhcpd start</p>



<p>Starting dhcpd: [&nbsp; OK&nbsp; ]</p>



<p><strong>5. 使 DHCP 守护进程在启动时启动</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;&nbsp;chkconfig dhcpd on</p>



<p><strong>6. 允许 DHCP 流量到达 DHCP 服务器</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;<code>iptables -A INPUT -i vlan1 -p udp --dport 67 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#&nbsp;<code>iptables -A INPUT -i vlan1 -p udp --dport 68 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#&nbsp;<code>iptables -A OUTPUT -o vlan1 -p udp --sport 67 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#&nbsp;<code>iptables -A OUTPUT -o vlan1 -p udp --sport 68 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#&nbsp;/etc/init.d/iptables save</p>



<h3 class="wp-block-heading">
<strong>Samba 服务器安装和配</strong><strong>置</strong>
</h3>



<p>为了允许 LAN 上的 Windows 用户访问 CentOS 上的主目录，我们必须安装和配置 Samba 服务器。</p>



<p><strong>1.&nbsp; 安装 Samba 服务器</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;yum install samba</p>



<p><strong>2. 创建 Linux 用户 brezular</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;adduser brezular</p>



<p>User brezular uid=500 belonging to the group gid=500 has been created. The home directory is /home/brezular/</p>



<p>更改用户 brezular 的密码。</p>



<p>root@swouter-x86 ~]#&nbsp;passwd brezular</p>



<p><strong>3. 配置 samba 服务器</strong></p>



<p><strong>a)&nbsp;编辑主配置文件 /etc/samba/smb.conf</strong></p>



<p>我们可以不修改此文件，因为它完全符合我们的需求。如果我们想让 CentOS 在 Windows 工作组中可见，我们必须更改工作组名称。由于我们在 CentOS 上没有安装任何打印机，请注释以 [printers] 开头的行</p>



<p>[root@swouter-x86 ~]#&nbsp;&nbsp;vi /etc/samba/smb.conf</p>



<p>#Interface on which is Samba running</p>



<p>interfaces = lo, vlan1</p>



<p>#Name of our Windows workgroup</p>



<p>workgroup = Workgroup</p>



<p>#[printers]</p>



<p>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; comment = All Printers</p>



<p>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; path = /var/spool/samba</p>



<p>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; browseable = no</p>



<p>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; guest ok = no</p>



<p>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; writable = no</p>



<p>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printable = yes</p>



<p><strong>b)&nbsp;创建 Samba 用户 brezular 并设置用户密码</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;smbpasswd -a brezular</p>



<p><strong>c)&nbsp;启动 smb 守护进程并使其在启动时自动启动</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;/etc/init.d/smb start</p>



<p>[root@swouter-x86 ~]#&nbsp;chkconfig smb on</p>



<p><strong>4. 配置防火墙以允许局域网上的主机访问他们的主目录</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;<code>iptables -A INPUT -i vlan1 -p tcp -m multiport --dport 137,138,139,445 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A INPUT -i vlan1 -p udp -m multiport --dport 137,138,139,445 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o vlan1 -p tcp -m multiport --sport 137,138,139,445 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#<code>iptables -A OUTPUT -o vlan1 -p udp -m multiport --sport 137,138,139,445 -j ACCEPT</code></p>



<p>[root@swouter-x86 ~]#&nbsp;/etc/init.d/iptables save</p>



<p><strong>5. 将 SELinux 策略设置为允许 Samba 用户访问他们的主目录</strong></p>



<p>[root@swouter-x86 ~]#&nbsp;setsebool -P samba_enable_home_dirs=1</p>



<p><strong>END.</strong></p>



<p>在编写本教程时，以下文章被广泛使用。</p>



<p>DHCP 服务器</p>



<p>http://www.linuxhelp.net/forums/Setup_Simple_Dhcp_Server_t4052.html</p>



<p>http://www.howtoforge.com/home-gateway-firewall-with-dhcp-server-for-connection-sharing-centos5</p>



<p>http://www.linuxjunkies.org/articles/dhcp-dejunkified.html</p>



<p>Samba 服务器</p>



<p>http://crazytoon.com/2007/05/22/samba-how-do-you-install-and-set-up-samba-in-linux-redhat-enterpriserhel-centos-fedora/</p>



<p>http://www.centos.org/docs/4/html/rhel-sag-en-4/s1-samba-configuring.html</p>



<p>http://troy.jdmz.net/samba/fw/</p>



<p>http://forums.fedoraforum.org/showthread.php?t=61018</p>



<p>http://www.redhatlinux.info/2011/11/configure-samba-server.html</p>
    </div>

    <!-- 底部元信息 -->
    <div class="post-footmeta mb-4">
        <div class="row d-flex align-items-center">
            <div class="col-md-6 col-12">
                <div class="post-share justify-content-sm-start mb-3 mb-sm-0">
                    <div class="post-btnmeta">
                        <span class="post-like trans_2ms" :class="postMeta.postLike_on ? 'on' : ''" @click="_setlike"><i class="cxicon cxicon-zan-black"></i> <em style="font-style: normal" x-text="postMeta.postLike" x-show="postMeta.postLike !== 0"></em></span>
                    </div>
                    <i class="cxline-1"></i>
                    <ul class="social-icons" x-data="{'postThumb':'/wp-content/themes/meteor/assets/images/nothumb.png','postLink' : window.location.href, 'postTitle' : document.title}">
                        <li class="list-inline-item">
                            <a href="javascript:;" title="分享到微信" x-bind="weixinLink"><i class="cxicon cxicon-weixin"></i></a>
                        </li>
                        <li class="list-inline-item">
                            <a href="javascript:;" title="分享到微博" x-bind="weiboLink"><i class="cxicon cxicon-weibo"></i></a>
                        </li>
                        <li class="list-inline-item">
                            <a href="javascript:;" title="分享到QQ" x-bind="qqLink"><i class="cxicon cxicon-qq"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-md-6 col-12 text-center text-md-end">
                <div class="tags">
                                    </div>
            </div>
        </div>
    </div>

    <div class="about-author p-4 mt-5 flex-sm-row">
        <div class="thumb"><a class="author" href="/archives/author/guozhiman"><figure class="figure-avatar  btn-default userid-1"><img alt="" src="http://cn.cravatar.com/avatar/740a87cfff4579440e19183a73f02b68?s=100&#038;d=mm&#038;r=g" srcset="http://cn.cravatar.com/avatar/740a87cfff4579440e19183a73f02b68?s=200&#038;d=mm&#038;r=g 2x" class="avatar avatar-100 photo" height="100" width="100" decoding="async"></figure></a></div>        <div class="details ps-sm-4 mt-3 mt-sm-0 text-sm-start">
            <h4 class="name"><a href="/archives/author/guozhiman" title="文章作者 guozhiman" rel="author">guozhiman</a></h4>
            <p>暂无介绍....</p>
            <ul class="social-icons list-unstyled list-inline mb-0">
                <!-- 社交信息 -->
                <li class="list-inline-item">
                    <a href="#"><i class="cxicon cxicon-weixin"></i></a>
                </li>
                <li class="list-inline-item">
                    <a href="#" target="_blank"><i class="cxicon cxicon-weibo"></i></a>
                </li>
                <li class="list-inline-item">
                    <a href="#" target="_blank"><i class="cxicon cxicon-qq"></i></a>
                </li>
                <li class="list-inline-item">
                    <i class="cxline-1 ms-0 me-2"></i>
                    <a href="/archives/author/guozhiman" class="author-link">TA的主页 <i class="cxicon cxicon-jtright font-inherit"></i></a>
                </li>
            </ul>
        </div>
    </div>

    <div class="row nextprev-post-wrapper mb-4">
        <div class="col-md-6 col-12 mb-3 mb-sm-0">
            <div class="nextprev-post prev">
                <span class="nextprev-text"> 上一篇</span>
                <h5 class="post-title">
                    <a href="/archives/399" rel="prev">通天星CMSV6 车载视频监控平台 信息泄露漏洞复现</a>                </h5>
            </div>
        </div>
        <div class="col-md-6 col-12">
            <div class="nextprev-post next text-sm-end">
                <span class="nextprev-text">下一篇</span>
                <h5 class="post-title">
                    <a href="/archives/405" rel="next">带有 LXD 和 Multipass 的工作站虚拟机</a>                </h5>
            </div>
        </div>
    </div>

    <section class="comments">
        <!-- 评论区代码 -->
    </section>

    <div class="mso nobg">
        <div class="module-tit item-center noborder">
            <h3 style="font-size:1rem">
<i class="cxline"></i>延伸阅读:</h3>
            <p></p>
        </div>
        <div class="module-content">
        <div class="item-jx item-blog small">
    <div class="jxbox">
        <div class="thumb">
            <a href="/archives/417">
                <div class="thumb-inner">
                    <img loading="lazy" decoding="async" src="/wp-content/uploads/2024/07/640-37.png" width="280" height="180" alt="OpenResty实战系列 | 异步非阻塞HTTP客户端库 Lua-Resty-Http">
                </div>
            </a> 
            <div class="sortbox">
                
                        <a href="/archives/category/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0" class="sort sort-5">技术文章</a>
                                    </div>                                           
        </div>
        <div class="subtitle">
            
            <!-- <p><span class="author">小牛爱奋斗</span>｜<span class="time">2023.10.21</span></p> -->
            <h5><a href="/archives/417">OpenResty实战系列 | 异步非阻塞HTTP客户端库 Lua-Resty-Http</a></h5>
            <p class="pdesc">概述 Lua-resty-http 是一个基于 OpenResty 的 Lua 库，是 OpenResty 项目中一个非...</p>
            <div class="pmbox">
                <div class="l">
                    <a class="author" href="/archives/author/guozhiman"><figure class="figure-avatar  btn-default userid-1"><img alt="" src="http://cn.cravatar.com/avatar/740a87cfff4579440e19183a73f02b68?s=30&#038;d=mm&#038;r=g" srcset="http://cn.cravatar.com/avatar/740a87cfff4579440e19183a73f02b68?s=60&#038;d=mm&#038;r=g 2x" class="avatar avatar-30 photo" height="30" width="30" decoding="async"></figure>guozhiman</a> <i class="cxicon cxicon-dian color-grad"></i> <span class="time">2024年7月22日</span>                </div>
                <div class="r">
                    <a href="/archives/417" class="more-link"><i class="cxicon cxicon-caidan-h"></i></a>
                </div>
                
            </div>
        </div>
    </div>
</div>
<div class="item-jx item-blog small">
    <div class="jxbox">
        <div class="thumb">
            <a href="/archives/407">
                <div class="thumb-inner">
                    <img loading="lazy" decoding="async" src="/wp-content/uploads/2024/07/640-2.jpeg" width="280" height="180" alt="树莓派 4安装 OpenWrt">
                </div>
            </a> 
            <div class="sortbox">
                
                        <a href="/archives/category/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0" class="sort sort-5">技术文章</a>
                                    </div>                                           
        </div>
        <div class="subtitle">
            
            <!-- <p><span class="author">小牛爱奋斗</span>｜<span class="time">2023.10.21</span></p> -->
            <h5><a href="/archives/407">树莓派 4安装 OpenWrt</a></h5>
            <p class="pdesc">树莓派4B板子上的各个部件：树莓派4B刷OpenWRT成为软路由后：我的采购清单： 要比较完美的在树莓派上安装Openw...</p>
            <div class="pmbox">
                <div class="l">
                    <a class="author" href="/archives/author/guozhiman"><figure class="figure-avatar  btn-default userid-1"><img alt="" src="http://cn.cravatar.com/avatar/740a87cfff4579440e19183a73f02b68?s=30&#038;d=mm&#038;r=g" srcset="http://cn.cravatar.com/avatar/740a87cfff4579440e19183a73f02b68?s=60&#038;d=mm&#038;r=g 2x" class="avatar avatar-30 photo" height="30" width="30" loading="lazy" decoding="async"></figure>guozhiman</a> <i class="cxicon cxicon-dian color-grad"></i> <span class="time">2024年7月22日</span>                </div>
                <div class="r">
                    <a href="/archives/407" class="more-link"><i class="cxicon cxicon-caidan-h"></i></a>
                </div>
                
            </div>
        </div>
    </div>
</div>
<div class="item-jx item-blog small">
    <div class="jxbox">
        <div class="thumb">
            <a href="/archives/405">
                <div class="thumb-inner">
                    <img loading="lazy" decoding="async" src="/wp-content/uploads/2024/07/640-10.jpeg" width="280" height="180" alt="带有 LXD 和 Multipass 的工作站虚拟机">
                </div>
            </a> 
            <div class="sortbox">
                
                        <a href="/archives/category/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0" class="sort sort-5">技术文章</a>
                                    </div>                                           
        </div>
        <div class="subtitle">
            
            <!-- <p><span class="author">小牛爱奋斗</span>｜<span class="time">2023.10.21</span></p> -->
            <h5><a href="/archives/405">带有 LXD 和 Multipass 的工作站虚拟机</a></h5>
            <p class="pdesc">目录 介绍 安装 / 分配 使用 Multipass 按需获取 Ubuntu LXD……用于虚拟机？ LXD 桌面虚拟机...</p>
            <div class="pmbox">
                <div class="l">
                    <a class="author" href="/archives/author/guozhiman"><figure class="figure-avatar  btn-default userid-1"><img alt="" src="http://cn.cravatar.com/avatar/740a87cfff4579440e19183a73f02b68?s=30&#038;d=mm&#038;r=g" srcset="http://cn.cravatar.com/avatar/740a87cfff4579440e19183a73f02b68?s=60&#038;d=mm&#038;r=g 2x" class="avatar avatar-30 photo" height="30" width="30" loading="lazy" decoding="async"></figure>guozhiman</a> <i class="cxicon cxicon-dian color-grad"></i> <span class="time">2024年7月22日</span>                </div>
                <div class="r">
                    <a href="/archives/405" class="more-link"><i class="cxicon cxicon-caidan-h"></i></a>
                </div>
                
            </div>
        </div>
    </div>
</div>
<div class="item-jx item-blog small">
    <div class="jxbox">
        <div class="thumb">
            <a href="/archives/403">
                <div class="thumb-inner">
                    <img loading="lazy" decoding="async" src="/wp-content/themes/meteor/assets/images/nothumb.png" width="280" height="180" alt="在 x86 上构建 Linux L3 交换机/路由器">
                </div>
            </a> 
            <div class="sortbox">
                
                        <a href="/archives/category/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0" class="sort sort-5">技术文章</a>
                                    </div>                                           
        </div>
        <div class="subtitle">
            
            <!-- <p><span class="author">小牛爱奋斗</span>｜<span class="time">2023.10.21</span></p> -->
            <h5><a href="/archives/403">在 x86 上构建 Linux L3 交换机/路由器</a></h5>
            <p class="pdesc">第 1 部分 - 介绍 1.&nbsp;构建 L3 交换机的教程都提供了什么内容？ 坦白地说，什么都没有。但是，如果您想...</p>
            <div class="pmbox">
                <div class="l">
                    <a class="author" href="/archives/author/guozhiman"><figure class="figure-avatar  btn-default userid-1"><img alt="" src="http://cn.cravatar.com/avatar/740a87cfff4579440e19183a73f02b68?s=30&#038;d=mm&#038;r=g" srcset="http://cn.cravatar.com/avatar/740a87cfff4579440e19183a73f02b68?s=60&#038;d=mm&#038;r=g 2x" class="avatar avatar-30 photo" height="30" width="30" loading="lazy" decoding="async"></figure>guozhiman</a> <i class="cxicon cxicon-dian color-grad"></i> <span class="time">2024年7月22日</span>                </div>
                <div class="r">
                    <a href="/archives/403" class="more-link"><i class="cxicon cxicon-caidan-h"></i></a>
                </div>
                
            </div>
        </div>
    </div>
</div>        </div>
    </div>
</article>                    </div>
                </div>
            </div>
            
            <div class="col-right" id="sidebar">
    <div class="rowright">
        <aside class="side-area">
            <div class="widget widget_block widget_search"><form role="search" method="get" action="/" class="wp-block-search__button-outside wp-block-search__text-button wp-block-search">
<label class="wp-block-search__label" for="wp-block-search__input-1">搜索</label><div class="wp-block-search__inside-wrapper ">
<input class="wp-block-search__input" id="wp-block-search__input-1" placeholder="" value="" type="search" name="s" required><button aria-label="搜索" class="wp-block-search__button wp-element-button" type="submit">搜索</button>
</div>
</form></div>
<div class="widget widget_block">
<div class="wp-block-group"><div class="wp-block-group__inner-container is-layout-flow wp-block-group-is-layout-flow">
<h2 class="wp-block-heading">近期文章</h2>


<ul class="wp-block-latest-posts__list wp-block-latest-posts">
<li><a class="wp-block-latest-posts__post-title" href="/archives/417">OpenResty实战系列 | 异步非阻塞HTTP客户端库 Lua-Resty-Http</a></li>
<li><a class="wp-block-latest-posts__post-title" href="/archives/415">GitHub上的宝藏：一套免费、开源的医院管理系统</a></li>
<li><a class="wp-block-latest-posts__post-title" href="/archives/413">开源远程桌面，TeamViewer 的替代品</a></li>
<li><a class="wp-block-latest-posts__post-title" href="/archives/411">免费！小区物业管理系统 开源</a></li>
<li><a class="wp-block-latest-posts__post-title" href="/archives/409">一款开源的设备资产管理系统</a></li>
</ul>
</div></div>
</div>
<div class="widget widget_block">
<div class="wp-block-group"><div class="wp-block-group__inner-container is-layout-flow wp-block-group-is-layout-flow">
<h2 class="wp-block-heading">近期评论</h2>


<div class="no-comments wp-block-latest-comments">没有评论可显示。</div>
</div></div>
</div>
<div class="widget widget_block">
<div class="wp-block-group"><div class="wp-block-group__inner-container is-layout-flow wp-block-group-is-layout-flow">
<h2 class="wp-block-heading">分类</h2>


<ul class="wp-block-categories-list wp-block-categories">	<li class="cat-item cat-item-4">
<a href="/archives/category/docker">Docker</a>
</li>
	<li class="cat-item cat-item-10">
<a href="/archives/category/caozuoxitong/linuxunix">Linux/Unix</a>
</li>
	<li class="cat-item cat-item-9">
<a href="/archives/category/caozuoxitong/windows">Win系统</a>
</li>
	<li class="cat-item cat-item-3">
<a href="/archives/category/qianduan">前端</a>
</li>
	<li class="cat-item cat-item-1">
<a href="/archives/category/kaiyuan">开源</a>
</li>
	<li class="cat-item cat-item-5">
<a href="/archives/category/%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0">技术文章</a>
</li>
	<li class="cat-item cat-item-6">
<a href="/archives/category/meirifenxiang">每日分享</a>
</li>
	<li class="cat-item cat-item-7">
<a href="/archives/category/wangluoanquan">网络安全</a>
</li>
</ul>
</div></div>
</div>        </aside>
    </div>
</div>        </div>
    </div>
</section>
<!-- 3.end -->

        </main><!-- main.end -->

        <footer class="footer-s1">
            <div class="linebox bg-auto"></div>
            <div class="foottop">
                <div class="container-xl">
                    <div class="footmain-box">
                        <div class="aboutus_link">
<a href="https://www.baidu.com/" target="_blank">百度一下</a><a href="https://yunsuo.qianxin.com/" target="_blank">云锁</a><a href="https://www.d99net.net/" target="_blank">D盾</a>
</div>
<div class="footer-desc">免责声明：本网站部分内容由用户自行上传，如权利人发现存在误传其作品情形，请及时与本站联系。</div>
<div class="foot-copyright">郭智满 © 2024. All Rights Reserved</div>                    </div>
                </div>
            </div>
        </footer>
        <!-- 弹出层代码 -->
        <div class="popbg-box trans_2ms" :class="{'visible': popBgshow}" @click="popBgshow = moibleMenu = false"></div>
        <div class="search-popup trans_2ms" :class="{'visible': searchPopup}">
            <button type="button" class="btn-close " aria-label="Close" @click="searchPopup = false"></button>
            <div class="search-content">
                <div class="search-form-box">
                    <form class="d-flex search-form" method="get" action="">
                        <input class="form-control me-2" placeholder="搜索并按回车键..." type="text" name="s" id="search" value="" aria-label="搜索">
                        <button class="btn btn-default btn-lg" type="submit" style="padding: 9.5px 36px;"><i class="cxicon cxicon-search"></i></button>
                    </form>
                </div>
                
            </div>
        </div>
        <!-- .end -->
        </div>
        <!--.sit-wrapper-->
        <script type="text/javascript" src="/wp-content/themes/meteor/assets/js/swiper-bundle.min.js?ver=1.2" id="cxm2-swiper-js"></script>
<script type="text/javascript" src="/wp-content/themes/meteor/assets/js/plugins.min.js?ver=1.2" id="cxm2-plugins-js"></script>
<script type="text/javascript" id="cxm2-alpine-js-extra">
/* <![CDATA[ */
var cxjs = {"homeurl":"","jsonapi":"\/wp-json\/cxv1\/","themedir":"\/wp-content\/themes\/meteor","ajaxurl":"\/wp-admin\/admin-ajax.php","postId":"403"};
/* ]]> */
</script>
<script type="text/javascript" src="/wp-content/themes/meteor/assets/js/alpine.min.js?ver=3.13.10" id="cxm2-alpine-js"></script>
        </body>

        </html>